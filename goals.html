<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ìš”ê¸ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <!-- í™˜ê²½ ì£¼ì… -->
  <script src="env.js"></script>
</head>
<body data-page="goals">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">--:--</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <section class="panel">
        <h3>ì ˆì•½ ëª©í‘œ í•œëˆˆì— íŒŒì•…í•˜ê¸°</h3>

        <!-- ì ˆì•½ ëª©í‘œ ì¹´ë“œ -->
        <div class="goal-card">
          <div class="goal-head" style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 class="goal-title" style="white-space:nowrap;margin:0;">ì´ë²ˆ ë‹¬ ì ˆì•½ ëª©í‘œ</h3>
            <div class="goal-side" style="display:flex;flex-direction:column;align-items:flex-end;line-height:1.2;">
              <span class="goal-meta" style="white-space:nowrap;">ëª©í‘œ: <span id="goalTarget">- ì›</span></span>
              <span class="goal-meta" style="white-space:nowrap;">ë‚¨ì€ ê¸ˆì•¡ <span id="goalRemain">- ì›</span></span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-track"><div id="goalFill" class="progress-fill" style="width:0%"></div></div>
            <div class="progress-label">
              <span id="savedNow">ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: - ì›</span>
              <span id="goalPct">0%</span>
            </div>
          </div>
          <form class="goal-form" id="goalForm">
            <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="ëª©í‘œ ê¸ˆì•¡ (ì˜ˆ: 50000)" />
            <div class="goal-actions">
              <button type="submit" class="btn">ì €ì¥</button>
              <button type="button" id="goalClear" class="btn">ì´ˆê¸°í™”</button>
            </div>
          </form>
        </div>

        <!-- ê·¼ì²˜ ìœ ì € ë¹„êµ -->
        <section class="neighbor-note">
          <p class="neighbor-title">
            ê·¼ì²˜ ìœ ì € ì¤‘ <strong class="hl">@@ë‹˜</strong>ì€ ì—ë„ˆì§€ ì ˆì•½ ì„±ê³µë¥ 
            <strong class="hl" id="rankTopText">ìƒìœ„ -%ì˜ˆìš”!</strong>
          </p>
          <div class="mini-colchart" aria-label="ê·¼ì²˜ ìœ ì € ë¹„êµ ê·¸ë˜í”„">
            <div class="col self"   id="colSelf"   style="--h:0%"><span class="val" id="selfVal">0%</span><span class="lab">ë‚˜</span></div>
            <div class="col others" id="colOthers" style="--h:0%"><span class="val" id="avgVal">0%</span><span class="lab" id="areaLab">ì§€ì—­ í‰ê· </span></div>
          </div>
        </section>

        <!-- ì¢…ëª©ë³„ ëª©í‘œ ì„¤ì •ê¸ˆì•¡ ë‹¬ì„±ë¥  -->
        <section class="cat-goals">
          <div class="goal-line" data-cat="elec" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">âš¡ ì „ê¸°</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> ì›</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>

          <div class="goal-line" data-cat="gas" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">ğŸ”¥ ê°€ìŠ¤</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> ì›</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>
        </section>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html">í™ˆ</a>
        <a class="tab" href="analysis.html">AI</a>
        <a class="tab active" href="goals.html">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div><div class="d-name">@@ë‹˜</div><div class="d-email">aaa123@gmail.com</div></div>
    </div>
    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>
    <div class="d-hr"></div>
    <div class="d-actions"><a href="#">ë¡œê·¸ì•„ì›ƒ</a><a href="#">íƒˆí‡´í•˜ê¸°</a></div>
  </aside>

  <!-- ìˆ«ì í¬ë§· & ì§„í–‰ë°” ê³„ì‚°(ë ˆì´ì•„ì›ƒ ë³€ê²½ ì—†ìŒ) -->
  <script>
    function fillGoalLine(row, now, target){
      const fmt = new Intl.NumberFormat('ko-KR');
      now = Number(now||0); target = Math.max(1, Number(target||0));
      const pct = Math.min(100, Math.round((now/target)*1000)/10);
      row.dataset.now = String(now); row.dataset.target = String(target);
      row.querySelector('.now').textContent = fmt.format(now);
      row.querySelector('.target').textContent = fmt.format(target);
      row.querySelector('.gl-pct').textContent = pct + '%';
      row.querySelector('.gl-fill').style.width = pct + '%';
    }
  </script>

  <!-- API ì—°ê²° -->
  <script>
    (function(){
      const { API_ORIGIN='', USER_ID, AREA } = window.__ENV; // env.js ì£¼ì…ê°’
      const fmt = new Intl.NumberFormat('ko-KR');
      const ym = (()=>{ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); })();
      
      // 1) ì›” ëª©í‘œ ì¹´ë“œ GET /api/month-goal?userId=&ym=
      async function fetchMonthGoal(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}`);
          if (res.status === 400) { alert('ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜(YYYY-MM)'); return; }
          if (!res.ok) return;
          const d = await res.json();
          const target  = Number(d.goalWon||0);
          const remain  = Number(d.remainingWon||0);
          const saved   = Number(d.savedWon||0);
          const percent = Math.max(0, Math.min(100, Number(d.savingPercent||0)));

          document.getElementById('goalTarget').textContent = fmt.format(target) + ' ì›';
          document.getElementById('goalRemain').textContent = fmt.format(remain) + ' ì›';
          document.getElementById('savedNow').textContent   = 'ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: ' + fmt.format(saved) + ' ì›';
          document.getElementById('goalPct').textContent    = (Math.round(percent*10)/10).toString().replace(/\.0$/,'') + '%';
          document.getElementById('goalFill').style.width   = percent + '%';

          // í˜„ì¬ ëª©í‘œê°’ì„ ì…ë ¥ì°½ì— ì„¸íŒ…
          const input = document.getElementById('goalInput');
          if (input) input.value = target ? String(target) : '';
        }catch(e){ console.warn(e); }
      }

      // ëª©í‘œ ì €ì¥ POST /api/month-goal   { userId, ym, goalWon }
      document.getElementById('goalForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const input = document.getElementById('goalInput');
        const val = Math.max(0, Number(input?.value||0));
        const goalWon = Math.round(val / 1000) * 1000;
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}&goalWon=${encodeURIComponent(goalWon)}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ userId: USER_ID, periodYm: ym, goalWon: Math.round(val) })
          });
          if (res.status === 400) { alert('ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜(ê¸°ê°„/ê¸ˆì•¡)'); return; }
          if (!res.ok) { alert('ì €ì¥ ì‹¤íŒ¨'); return; }
          await fetchMonthGoal();
        }catch(err){ console.warn(err); }
      });

      // ëª©í‘œ ì´ˆê¸°í™” POST /api/month-goal/reset   { userId, ym }
      document.getElementById('goalClear')?.addEventListener('click', async ()=>{
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal/reset`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ userId: USER_ID, periodYm:ym })
          });
          if (!res.ok) { // ì´ˆê¸°í™” APIê°€ ì—†ìœ¼ë©´ UIë§Œ ì´ˆê¸°í™”
            console.warn('reset api not ok, fallback to UI reset');
          }
        }catch(e){ console.warn(e); }
        // UI ì´ˆê¸°í™”
        const input = document.getElementById('goalInput');
        if (input) input.value = '';
        document.getElementById('goalFill').style.width = '0%';
        document.getElementById('goalPct').textContent = '0%';
        document.getElementById('goalTarget').textContent = '- ì›';
        document.getElementById('goalRemain').textContent = '- ì›';
        document.getElementById('savedNow').textContent = 'ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: - ì›';
      });

      // 2) ë­í‚¹/ì„±ê³µë¥  GET /api/ranking?userId=&area=&ym=
      async function fetchRanking(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/ranking?userId=${encodeURIComponent(USER_ID)}&area=${encodeURIComponent(AREA)}&ym=${encodeURIComponent(ym)}`);
          if (!res.ok) return;
          const d = await res.json(); // { myRate, areaAvgRate, topPercent, area, ... }
          const self = Math.max(0, Math.min(100, Number(d.myRate||0)));
          const avg  = Math.max(0, Math.min(100, Number(d.areaAvgRate||0)));
          const top  = Number(d.topPercent||0);

          document.getElementById('rankTopText').textContent = `ìƒìœ„ ${top}%ì˜ˆìš”!`;
          document.getElementById('colSelf').style.setProperty('--h', self+'%');
          document.getElementById('selfVal').textContent = self.toFixed(0) + '%';
          document.getElementById('colOthers').style.setProperty('--h', avg+'%');
          document.getElementById('avgVal').textContent = avg.toFixed(0) + '%';
          document.getElementById('areaLab').textContent = (d.area || AREA) + ' ìœ ì €';
        }catch(e){ console.warn(e); }
      }

      // 3) í•˜ë‹¨ ì¢…ëª©ë³„ ëª©í‘œ ê·¸ë˜í”„ GET /api/savebars?userId=&ym=
      async function fetchSavebars(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/savebars?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}`);
          if (!res.ok) return;
          const arr = await res.json(); // [{category:'elec'|'gas', target, used, ...}, ...]
          const byCat = Object.fromEntries((arr||[]).map(it=>[String(it.category||'').toLowerCase(), it]));
          document.querySelectorAll('.goal-line').forEach(row=>{
            const cat = row.dataset.cat;
            const d = byCat[cat];
            if (!d) return;
            fillGoalLine(row, Number(d.used||0), Number(d.target||1));
          });
        }catch(e){ console.warn(e); }
      }

      // ì´ˆê¸° ë¡œë“œ
      document.addEventListener('DOMContentLoaded', ()=>{
        fetchMonthGoal();
        fetchRanking();
        fetchSavebars();
      });
    })();
  </script>

  <!-- Drawer (ê¸°ì¡´) -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      const open=()=>{dr.classList.add('open'); sc.classList.add('show');};
      const close=()=>{dr.classList.remove('open'); sc.classList.remove('show');};
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
</body>
</html>
