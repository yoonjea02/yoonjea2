<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>실시간 요금</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <!-- 환경 주입 -->
  <script src="env.js"></script>
</head>
<body data-page="goals">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">--:--</div>
        <div class="status" aria-hidden="true"><span>📶</span><span>📡</span><span>🔋</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">로그</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="알림">🔔</a>
          <a class="icon-btn" href="search.html" aria-label="검색">🔎</a>
          <button class="icon-btn" id="openDrawer" aria-label="전체 메뉴">🧭</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <section class="panel">
        <h3>절약 목표 한눈에 파악하기</h3>

        <!-- 절약 목표 카드 -->
        <div class="goal-card">
          <div class="goal-head" style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 class="goal-title" style="white-space:nowrap;margin:0;">이번 달 절약 목표</h3>
            <div class="goal-side" style="display:flex;flex-direction:column;align-items:flex-end;line-height:1.2;">
              <span class="goal-meta" style="white-space:nowrap;">목표: <span id="goalTarget">- 원</span></span>
              <span class="goal-meta" style="white-space:nowrap;">남은 금액 <span id="goalRemain">- 원</span></span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-track"><div id="goalFill" class="progress-fill" style="width:0%"></div></div>
            <div class="progress-label">
              <span id="savedNow">이번 달 절감액: - 원</span>
              <span id="goalPct">0%</span>
            </div>
          </div>
          <form class="goal-form" id="goalForm">
            <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="목표 금액 (예: 50000)" />
            <div class="goal-actions">
              <button type="submit" class="btn">저장</button>
              <button type="button" id="goalClear" class="btn">초기화</button>
            </div>
          </form>
        </div>

        <!-- 근처 유저 비교 -->
        <section class="neighbor-note">
          <p class="neighbor-title">
            근처 유저 중 <strong class="hl">@@님</strong>은 에너지 절약 성공률
            <strong class="hl" id="rankTopText">상위 -%예요!</strong>
          </p>
          <div class="mini-colchart" aria-label="근처 유저 비교 그래프">
            <div class="col self"   id="colSelf"   style="--h:0%"><span class="val" id="selfVal">0%</span><span class="lab">나</span></div>
            <div class="col others" id="colOthers" style="--h:0%"><span class="val" id="avgVal">0%</span><span class="lab" id="areaLab">지역 평균</span></div>
          </div>
        </section>

        <!-- 종목별 목표 설정금액 달성률 -->
        <section class="cat-goals">
          <div class="goal-line" data-cat="elec" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">⚡ 전기</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> 원</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>

          <div class="goal-line" data-cat="gas" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">🔥 가스</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> 원</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>
        </section>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html">홈</a>
        <a class="tab" href="analysis.html">AI</a>
        <a class="tab active" href="goals.html">요금</a>
        <a class="tab" href="profile.html">마이</a>
        <button class="tab" id="openDrawer2" type="button">전체</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="전체 메뉴">
    <div class="d-hero">
      <div class="d-avatar">👤</div>
      <div><div class="d-name">@@님</div><div class="d-email">aaa123@gmail.com</div></div>
    </div>
    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">👤</div><div class="label">정보 관리</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">🔔</div><div class="label">알림</div></a>
      <a class="d-btn" href="#"><div class="emoji">📢</div><div class="label">공지사항</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">👤</div><div class="label">마이페이지</div></a>
      <a class="d-btn" href="#"><div class="emoji">💬</div><div class="label">고객센터</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">🔎</div><div class="label">검색</div></a>
    </div>
    <div class="d-hr"></div>
    <div class="d-actions"><a href="#">로그아웃</a><a href="#">탈퇴하기</a></div>
  </aside>

  <!-- 숫자 포맷 & 진행바 계산(레이아웃 변경 없음) -->
  <script>
    function fillGoalLine(row, now, target){
      const fmt = new Intl.NumberFormat('ko-KR');
      now = Number(now||0); target = Math.max(1, Number(target||0));
      const pct = Math.min(100, Math.round((now/target)*1000)/10);
      row.dataset.now = String(now); row.dataset.target = String(target);
      row.querySelector('.now').textContent = fmt.format(now);
      row.querySelector('.target').textContent = fmt.format(target);
      row.querySelector('.gl-pct').textContent = pct + '%';
      row.querySelector('.gl-fill').style.width = pct + '%';
    }
  </script>

  <!-- API 연결 -->
  <script>
    (function(){
      const { API_ORIGIN='', USER_ID, AREA } = window.__ENV; // env.js 주입값
      const fmt = new Intl.NumberFormat('ko-KR');
      const ym = (()=>{ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); })();
      
      // 1) 월 목표 카드 GET /api/month-goal?userId=&ym=
      async function fetchMonthGoal(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}`);
          if (res.status === 400) { alert('요청 형식 오류(YYYY-MM)'); return; }
          if (!res.ok) return;
          const d = await res.json();
          const target  = Number(d.goalWon||0);
          const remain  = Number(d.remainingWon||0);
          const saved   = Number(d.savedWon||0);
          const percent = Math.max(0, Math.min(100, Number(d.savingPercent||0)));

          document.getElementById('goalTarget').textContent = fmt.format(target) + ' 원';
          document.getElementById('goalRemain').textContent = fmt.format(remain) + ' 원';
          document.getElementById('savedNow').textContent   = '이번 달 절감액: ' + fmt.format(saved) + ' 원';
          document.getElementById('goalPct').textContent    = (Math.round(percent*10)/10).toString().replace(/\.0$/,'') + '%';
          document.getElementById('goalFill').style.width   = percent + '%';

          // 현재 목표값을 입력창에 세팅
          const input = document.getElementById('goalInput');
          if (input) input.value = target ? String(target) : '';
        }catch(e){ console.warn(e); }
      }

      // 목표 저장 POST /api/month-goal   { userId, ym, goalWon }
      document.getElementById('goalForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const input = document.getElementById('goalInput');
        const val = Math.max(0, Number(input?.value||0));
        const goalWon = Math.round(val / 1000) * 1000;
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}&goalWon=${encodeURIComponent(goalWon)}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ userId: USER_ID, periodYm: ym, goalWon: Math.round(val) })
          });
          if (res.status === 400) { alert('요청 형식 오류(기간/금액)'); return; }
          if (!res.ok) { alert('저장 실패'); return; }
          await fetchMonthGoal();
        }catch(err){ console.warn(err); }
      });

      // 목표 초기화 POST /api/month-goal/reset   { userId, ym }
      document.getElementById('goalClear')?.addEventListener('click', async ()=>{
        try{
          const res = await fetch(`${API_ORIGIN}/api/month-goal/reset`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ userId: USER_ID, periodYm:ym })
          });
          if (!res.ok) { // 초기화 API가 없으면 UI만 초기화
            console.warn('reset api not ok, fallback to UI reset');
          }
        }catch(e){ console.warn(e); }
        // UI 초기화
        const input = document.getElementById('goalInput');
        if (input) input.value = '';
        document.getElementById('goalFill').style.width = '0%';
        document.getElementById('goalPct').textContent = '0%';
        document.getElementById('goalTarget').textContent = '- 원';
        document.getElementById('goalRemain').textContent = '- 원';
        document.getElementById('savedNow').textContent = '이번 달 절감액: - 원';
      });

      // 2) 랭킹/성공률 GET /api/ranking?userId=&area=&ym=
      async function fetchRanking(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/ranking?userId=${encodeURIComponent(USER_ID)}&area=${encodeURIComponent(AREA)}&ym=${encodeURIComponent(ym)}`);
          if (!res.ok) return;
          const d = await res.json(); // { myRate, areaAvgRate, topPercent, area, ... }
          const self = Math.max(0, Math.min(100, Number(d.myRate||0)));
          const avg  = Math.max(0, Math.min(100, Number(d.areaAvgRate||0)));
          const top  = Number(d.topPercent||0);

          document.getElementById('rankTopText').textContent = `상위 ${top}%예요!`;
          document.getElementById('colSelf').style.setProperty('--h', self+'%');
          document.getElementById('selfVal').textContent = self.toFixed(0) + '%';
          document.getElementById('colOthers').style.setProperty('--h', avg+'%');
          document.getElementById('avgVal').textContent = avg.toFixed(0) + '%';
          document.getElementById('areaLab').textContent = (d.area || AREA) + ' 유저';
        }catch(e){ console.warn(e); }
      }

      // 3) 하단 종목별 목표 그래프 GET /api/savebars?userId=&ym=
      async function fetchSavebars(){
        try{
          const res = await fetch(`${API_ORIGIN}/api/savebars?userId=${encodeURIComponent(USER_ID)}&ym=${encodeURIComponent(ym)}`);
          if (!res.ok) return;
          const arr = await res.json(); // [{category:'elec'|'gas', target, used, ...}, ...]
          const byCat = Object.fromEntries((arr||[]).map(it=>[String(it.category||'').toLowerCase(), it]));
          document.querySelectorAll('.goal-line').forEach(row=>{
            const cat = row.dataset.cat;
            const d = byCat[cat];
            if (!d) return;
            fillGoalLine(row, Number(d.used||0), Number(d.target||1));
          });
        }catch(e){ console.warn(e); }
      }

      // 초기 로드
      document.addEventListener('DOMContentLoaded', ()=>{
        fetchMonthGoal();
        fetchRanking();
        fetchSavebars();
      });
    })();
  </script>

  <!-- Drawer (기존) -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      const open=()=>{dr.classList.add('open'); sc.classList.add('show');};
      const close=()=>{dr.classList.remove('open'); sc.classList.remove('show');};
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
</body>
</html>
