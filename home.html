<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리 요금 예측 · 홈</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />

  <!-- (옵션) 라인/막대 영역 레이아웃 보정 -->
  <style>
    body[data-page="home"] { touch-action: pan-y; }
    body[data-page="home"] .wrap { overflow-x: hidden; }

    /* “예상 관리 요금 한눈에” 섹션만 가로 스크롤 */
    body[data-page="home"] section.panel[aria-label="예상 관리 요금 한눈에"]{ overflow: hidden; }
    body[data-page="home"] section.panel[aria-label="예상 관리 요금 한눈에"] .cards{
      display: flex !important;
      width: 100%;
      gap: 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
      overscroll-behavior-x: contain;
      scroll-snap-type: x mandatory;
      padding-bottom: 4px;
    }
    body[data-page="home"] section.panel[aria-label="예상 관리 요금 한눈에"] .cards > .card{
      flex: 0 0 100%;
      max-width: 100%;
      scroll-snap-align: start;
    }

    /* 막대 차트를 그릴 컨테이너 */
    .chart-line { position: relative; min-height: 200px; }
  </style>
</head>
<body data-page="home">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="top-bar">
        <div class="time">19:30</div>
        <div class="status" aria-hidden="true"><span>📶</span><span>📡</span><span>🔋</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html" aria-label="로그">로그</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="알림">🔔</a>
          <a class="icon-btn" href="search.html" aria-label="검색">🔎</a>
          <button class="icon-btn" id="openDrawer" aria-label="전체 메뉴">🧭</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="section stack">
      <!-- 프로필 -->
      <div class="hero" aria-label="프로필">
        <div class="avatar" aria-hidden="true">👤</div>
        <div>
          <div class="name">@@님</div>
          <div class="email">aaa123@gmail.com</div>
        </div>
      </div>

      <!-- 월 요약 -->
      <section class="summary" aria-label="이달 관리 요금 요약">
        <h2>@@님의 <span id="summaryMonth">이번 달</span> 예상 관리 요금 <span class="kpi" id="totalPrice">0 원</span></h2>
        <p class="small" id="deltaText">비교 데이터를 불러오는 중…</p>
        <div class="bars">
          <div class="bar">
            <span class="label">지난달</span>
            <div class="track"><div class="fill july" id="barJuly" style="width:50%"></div></div>
          </div>
          <div class="bar">
            <span class="label">이번달</span>
            <div class="track"><div class="fill aug" id="barAug" style="width:50%"></div></div>
          </div>
        </div>
      </section>

      <!-- 카드: 전기/가스 -->
      <section class="panel" aria-label="예상 관리 요금 한눈에">
        <h3 style="margin:0 0 12px">예상 관리 요금 한눈에 모아보기 &gt;</h3>
        <div class="cards">
          <article class="card" aria-label="전기">
            <div class="label">⚡ 예상 전기 요금</div>
            <div class="kpi" id="elecPrice">0 원</div>
            <div class="donut" id="donutElec" style="--percent:0"><div class="center">전기 비중</div></div>
          </article>
          <article class="card" aria-label="가스">
            <div class="label">🔥 예상 가스 요금</div>
            <div class="kpi" id="gasPrice">0 원</div>
            <div class="donut" id="donutGas" style="--percent:0"><div class="center">가스 비중</div></div>
          </article>
        </div>
      </section>

      <!-- 누적 막대차트 -->
      <section class="panel">
        <h3>이번 달 전기/가스 누적</h3>
        <div id="chartBars" class="chart-line"></div>
      </section>

      <!-- 절약 목표 -->
      <section class="goal-card" aria-label="절약 목표">
        <div class="goal-head">
          <h3 class="goal-title">이번 달 절약 목표</h3>
          <span id="goalHint" class="goal-meta">목표를 설정해 진행률을 확인해 보세요</span>
        </div>

        <div class="progress">
          <div class="progress-track"><div id="goalFill" class="progress-fill"></div></div>
          <div class="progress-label">
            <span id="savedNow">이번 달 절감액: 0 원</span>
            <span id="goalPct">0%</span>
          </div>
        </div>

        <form class="goal-form" id="goalForm">
          <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="목표 금액을 입력하세요 (예: 30000)" />
          <button type="submit" class="btn">저장</button>
          <button type="button" id="goalClear" class="btn">초기화</button>
        </form>

        <div id="goalSuccess" style="display:none">
          <span class="badge-success">목표 달성!</span>
        </div>
      </section>
    </main>

    <!-- Footer Tabs -->
    <footer>
      <div class="tabs" aria-label="탭">
        <a class="tab active" href="home.html" aria-label="홈">홈</a>
        <a class="tab" href="analysis.html" aria-label="AI 분석">AI</a>
        <a class="tab" href="goals.html" aria-label="실시간 요금">요금</a>
        <a class="tab" href="profile.html" aria-label="마이페이지">마이</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="전체">전체</button>
      </div>
    </footer>
  </div>

  <!-- Drawer (공통) -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="전체 메뉴">
    <div class="d-hero">
      <div class="d-avatar">👤</div>
      <div>
        <div class="d-name">@@님</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">👤</div><div class="label">정보 관리</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">🔔</div><div class="label">알림</div></a>
      <a class="d-btn" href="#"><div class="emoji">📢</div><div class="label">공지사항</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">👤</div><div class="label">마이페이지</div></a>
      <a class="d-btn" href="#"><div class="emoji">💬</div><div class="label">고객센터</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">🔎</div><div class="label">검색</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">로그아웃</a>
      <a href="#">탈퇴하기</a>
    </div>
  </aside>

  <!-- Scripts -->
  <script src="app3.js" defer></script>

  <!-- Drawer 열고/닫기 -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr || !sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>

  <!-- ✅ 공통 환경값 (주소/사용자) -->
  <script>
    // 기본값(개발용). 운영에서는 env.js로 window.APP_CONF를 먼저 정의하거나, 아래를 빈 문자열("")로 바꾸세요.
    window.APP_CONF = window.APP_CONF || {};
    if (!('API_ORIGIN' in window.APP_CONF)) window.APP_CONF.API_ORIGIN = "http://localhost:8080"; // 배포 프록시면 ""
    if (!('USER_ID' in window.APP_CONF))    window.APP_CONF.USER_ID    = 1;
  </script>

  <!-- ✅ 1) 도넛 차트 연동: GET /api/dashboard/donut?userId=&period=YYYY-MM -->
  <script>
  (async function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const ENDPOINT = (API_ORIGIN || "") + "/api/dashboard/donut";

    const now = new Date();
    const period = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
    document.getElementById("summaryMonth").textContent = `${now.getMonth()+1}월`;

    const isYm = /^\d{4}-(0[1-9]|1[0-2])$/.test(period);
    if (!isYm) return;

    const $elecPrice = document.getElementById("elecPrice");
    const $gasPrice  = document.getElementById("gasPrice");
    const $total     = document.getElementById("totalPrice");
    const $donutElec = document.getElementById("donutElec");
    const $donutGas  = document.getElementById("donutGas");
    const fmt = new Intl.NumberFormat("ko-KR");

    try{
      const url = `${ENDPOINT}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) return; // 400/500은 그대로 무시
      const data = await res.json(); // {periodYm, elec, gas, total, elecRatio, gasRatio}

      if ($elecPrice && typeof data.elec === "number") $elecPrice.textContent = `${fmt.format(data.elec)} 원`;
      if ($gasPrice  && typeof data.gas  === "number") $gasPrice.textContent  = `${fmt.format(data.gas)} 원`;
      if ($total     && typeof data.total=== "number") $total.textContent     = `${fmt.format(data.total)} 원`;

      const elecPct = Math.max(0, Math.min(100, Math.round((data.elecRatio || 0) * 100)));
      const gasPct  = Math.max(0, Math.min(100, Math.round((data.gasRatio  || 0) * 100)));
      if ($donutElec) $donutElec.style.setProperty("--percent", elecPct);
      if ($donutGas)  $donutGas .style.setProperty("--percent", gasPct);
    }catch(e){ /* 네트워크 오류 시 화면 유지 */ }
  })();
  </script>

  <!-- ✅ 2) 누적 막대 차트: GET /api/dashboard/bars?userId=&period=YYYY-MM -->
  <script>
  (async function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const ENDPOINT = (API_ORIGIN || "") + "/api/dashboard/bars";

    const now = new Date();
    const period = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
    const isYm = /^\d{4}-(0[1-9]|1[0-2])$/.test(period);
    if (!isYm) return;

    const container = document.getElementById("chartBars") || document.querySelector(".chart-line");
    if (!container) return;

    let data;
    try{
      const url = `${ENDPOINT}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) { container.textContent="데이터가 없습니다."; return; }
      data = await res.json(); // { periodYm, bars:[{day, elecCum, gasCum, totalCum}, ...] }
    }catch(e){ container.textContent="네트워크 오류"; return; }

    if (!data || !Array.isArray(data.bars) || !data.bars.length) {
      container.textContent = "데이터가 없습니다."; return;
    }

    function draw(){
      container.innerHTML = "";
      const width  = Math.max(240, container.clientWidth || 320);
      const height = 200;
      const M = {top:10,right:10,bottom:24,left:30};
      const iw = width - M.left - M.right;
      const ih = height - M.top - M.bottom;

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width", width); svg.setAttribute("height", height);

      const maxY = data.bars.reduce((m,b)=>Math.max(m, b.totalCum||0), 1);
      const n = data.bars.length;
      const slot = iw / n;
      const barW = Math.max(3, Math.min(20, slot*0.6));
      const baseY = height - M.bottom;

      // grid
      const grid = document.createElementNS(svg.namespaceURI,"g");
      for(let i=1;i<=3;i++){
        const y = M.top + ih * i / 4;
        const line = document.createElementNS(svg.namespaceURI,"line");
        line.setAttribute("x1", M.left); line.setAttribute("y1", y);
        line.setAttribute("x2", width-M.right); line.setAttribute("y2", y);
        line.setAttribute("stroke","rgba(0,0,0,.08)");
        grid.appendChild(line);
      }
      svg.appendChild(grid);

      const barsG = document.createElementNS(svg.namespaceURI,"g");
      data.bars.forEach((b,i)=>{
        const xCenter = M.left + i*slot + slot/2;
        const x = xCenter - barW/2;

        const totalH = ih * (Math.max(0,b.totalCum||0) / maxY);
        const elecH  = ih * (Math.max(0,b.elecCum ||0)  / maxY);
        const gasH   = Math.max(0, totalH - elecH);

        const r1 = document.createElementNS(svg.namespaceURI,"rect"); // gas
        r1.setAttribute("x",x); r1.setAttribute("y", baseY-gasH);
        r1.setAttribute("width",barW); r1.setAttribute("height",gasH);
        r1.setAttribute("fill","#f97316"); r1.setAttribute("rx","2");
        barsG.appendChild(r1);

        const r2 = document.createElementNS(svg.namespaceURI,"rect"); // elec
        r2.setAttribute("x",x); r2.setAttribute("y", baseY-totalH);
        r2.setAttribute("width",barW); r2.setAttribute("height",elecH);
        r2.setAttribute("fill","#facc15"); r2.setAttribute("rx","2");
        barsG.appendChild(r2);

        if (b.day % 5 === 0 || i===0 || i===n-1){
          const t = document.createElementNS(svg.namespaceURI,"text");
          t.setAttribute("x", xCenter); t.setAttribute("y", baseY+14);
          t.setAttribute("text-anchor","middle"); t.setAttribute("font-size","10");
          t.setAttribute("fill","rgba(0,0,0,.55)"); t.textContent = b.day;
          barsG.appendChild(t);
        }
      });
      svg.appendChild(barsG);

      // legend
      const lg = document.createElementNS(svg.namespaceURI,"g");
      [["#facc15","전기 누적"],["#f97316","가스 누적"]].forEach((it,idx)=>{
        const x = width - M.right - 120 + idx*60, y = M.top+10;
        const s = document.createElementNS(svg.namespaceURI,"rect");
        s.setAttribute("x",x); s.setAttribute("y",y-8); s.setAttribute("width",10); s.setAttribute("height",10);
        s.setAttribute("fill",it[0]); s.setAttribute("rx","2");
        const tx = document.createElementNS(svg.namespaceURI,"text");
        tx.setAttribute("x",x+14); tx.setAttribute("y",y); tx.setAttribute("font-size","10"); tx.textContent=it[1];
        tx.setAttribute("fill","rgba(0,0,0,.6)");
        lg.appendChild(s); lg.appendChild(tx);
      });
      svg.appendChild(lg);

      container.appendChild(svg);
    }
    draw();
    let t; window.addEventListener("resize", ()=>{ clearTimeout(t); t=setTimeout(draw,120); });
  })();
  </script>

  <!-- ✅ 3) 절약 목표 저장: POST /api/dashboard/goal  &  조회: GET /api/dashboard/goal -->
  <script>
  // 저장(POST)
  (function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const API_URL = (API_ORIGIN || "") + "/api/dashboard/goal";

    const d = document;
    const form    = d.getElementById("goalForm");
    const input   = d.getElementById("goalInput");
    const hintEl  = d.getElementById("goalHint");
    const pctEl   = d.getElementById("goalPct");
    const fillEl  = d.getElementById("goalFill");
    const savedEl = d.getElementById("savedNow");
    const badge   = d.getElementById("goalSuccess");
    const fmt = new Intl.NumberFormat("ko-KR");

    if (!form) return;

    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const ym = ()=>{ const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0"); };

    function msg(t,err){ if(!hintEl) return; hintEl.textContent=t; hintEl.style.color = err ? "#e11d48" : ""; }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const val = Number(input.value);
      if (!Number.isFinite(val) || val < 0){ msg("목표 금액을 0 이상 숫자로 입력해 주세요.", true); return; }

      const body = { userId: USER_ID, periodYm: ym(), savingGoalWon: Math.round(val) };
      if (!/^\d{4}-(0[1-9]|1[0-2])$/.test(body.periodYm)){ msg("기간 형식(YYYY-MM)이 올바르지 않습니다.", true); return; }

      try{
        const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if (res.status === 400){ msg("요청 형식 오류: 기간 또는 금액을 확인해 주세요.", true); return; }
        if (!res.ok){ msg("서버 오류로 저장하지 못했어요.", true); return; }

        const data = await res.json(); // GoalResponse
        const baseline = Number(data.baselineTotalWon || 0);
        const current  = Number(data.currentTotalWon  || 0);
        const saved    = Math.max(0, baseline - current);
        const percent  = clamp(Number(data.savingPercent || 0), 0, 100);

        if (savedEl) savedEl.textContent = `이번 달 절감액: ${fmt.format(saved)} 원`;
        if (pctEl)   pctEl.textContent   = `${percent.toFixed(1)}%`;
        if (fillEl)  fillEl.style.width  = `${percent}%`;
        if (badge)   badge.style.display = percent>=100 ? "block" : "none";

        msg(`목표 ${fmt.format(data.savingGoalWon)} 원 저장 완료!`);
      }catch(e){ msg("네트워크 오류로 저장하지 못했어요.", true); }
    });

    d.getElementById("goalClear")?.addEventListener("click", ()=>{
      if (pctEl)   pctEl.textContent = "0%";
      if (fillEl)  fillEl.style.width="0%";
      if (savedEl) savedEl.textContent="이번 달 절감액: 0 원";
      if (input)   input.value="";
      msg("목표를 설정해 진행률을 확인해 보세요", false);
      if (badge)   badge.style.display="none";
    });
  })();

  // 조회(GET) + 요약(상단 총액/증감, 막대 너비)도 같이 갱신
  (function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const API_URL = (API_ORIGIN || "") + "/api/dashboard/goal";

    const d = document;
    const input   = d.getElementById("goalInput");
    const hintEl  = d.getElementById("goalHint");
    const pctEl   = d.getElementById("goalPct");
    const fillEl  = d.getElementById("goalFill");
    const savedEl = d.getElementById("savedNow");
    const badge   = d.getElementById("goalSuccess");

    // 월 요약에 있는 요소들
    const totalEl = d.getElementById("totalPrice");
    const deltaEl = d.getElementById("deltaText");
    const barJuly = d.getElementById("barJuly");
    const barAug  = d.getElementById("barAug");

    const fmt = new Intl.NumberFormat("ko-KR");
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const ym = ()=>{ const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0"); };
    function msg(t,err){ if(!hintEl) return; hintEl.textContent=t; hintEl.style.color = err ? "#e11d48" : ""; }

    async function fetchGoal(){
      const period = ym();
      if (!/^\d{4}-(0[1-9]|1[0-2])$/.test(period)){ msg("기간 형식(YYYY-MM)이 올바르지 않습니다.", true); return; }

      const url = `${API_URL}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      try{
        const res = await fetch(url);
        if (res.status === 204){ msg("목표를 설정해 진행률을 확인해 보세요"); return; }
        if (res.status === 400){ msg("요청 형식 오류: 기간(YYYY-MM)을 확인해 주세요.", true); return; }
        if (!res.ok){ msg("서버 오류로 목표를 불러오지 못했어요.", true); return; }

        const data = await res.json(); // GoalResponse
        const target   = Number(data.savingGoalWon || 0);
        const baseline = Number(data.baselineTotalWon || 0); // 지난달 총액
        const current  = Number(data.currentTotalWon  || 0); // 이번달 총액
        const saved    = Math.max(0, baseline - current);
        const percent  = clamp(Number(data.savingPercent || ((baseline>0)? (baseline-current)/baseline*100 : 0)), 0, 100);

        if (input)   input.value = target ? String(target) : "";
        if (savedEl) savedEl.textContent = `이번 달 절감액: ${fmt.format(saved)} 원`;
        if (pctEl)   pctEl.textContent   = `${percent.toFixed(1)}%`;
        if (fillEl)  fillEl.style.width  = `${percent}%`;
        if (badge)   badge.style.display = percent>=100 ? "block" : "none";
        msg(`목표: ${fmt.format(target)} 원 · 남은 금액 ${fmt.format(Math.max(0,target - saved))} 원`);

        // 상단 요약도 함께 갱신 (총액/증감/막대 너비)
        if (totalEl) totalEl.textContent = `${fmt.format(current)} 원`;
        if (baseline>0 && deltaEl){
          const diffPct = ((current - baseline) / baseline) * 100;
          const absPct  = Math.abs(diffPct).toFixed(1);
          deltaEl.textContent = diffPct<=0
            ? `지난달 보다 ${absPct}% 낮은 금액이에요!`
            : `지난달 보다 ${absPct}% 높은 금액이에요!`;
        }else if(deltaEl){
          deltaEl.textContent = "비교할 지난달 데이터가 없습니다.";
        }
        if (barJuly && barAug){
          const max = Math.max(baseline, current, 1);
          barJuly.style.width = `${Math.round(baseline/max*100)}%`;
          barAug .style.width = `${Math.round(current /max*100)}%`;
        }
      }catch(e){ msg("네트워크 오류로 목표를 불러오지 못했어요.", true); }
    }

    document.addEventListener("DOMContentLoaded", fetchGoal);
  })();
  </script>

</body>
</html>
