<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ ìš”ê¸ˆ ì˜ˆì¸¡ Â· í™ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />

  <!-- (ì˜µì…˜) ë¼ì¸/ë§‰ëŒ€ ì˜ì—­ ë ˆì´ì•„ì›ƒ ë³´ì • -->
  <style>
    body[data-page="home"] { touch-action: pan-y; }
    body[data-page="home"] .wrap { overflow-x: hidden; }

    /* â€œì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—â€ ì„¹ì…˜ë§Œ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"]{ overflow: hidden; }
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"] .cards{
      display: flex !important;
      width: 100%;
      gap: 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
      overscroll-behavior-x: contain;
      scroll-snap-type: x mandatory;
      padding-bottom: 4px;
    }
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"] .cards > .card{
      flex: 0 0 100%;
      max-width: 100%;
      scroll-snap-align: start;
    }

    /* ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ê·¸ë¦´ ì»¨í…Œì´ë„ˆ */
    .chart-line { position: relative; min-height: 200px; }
  </style>
</head>
<body data-page="home">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="top-bar">
        <div class="time">19:30</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html" aria-label="ë¡œê·¸">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="section stack">
      <!-- í”„ë¡œí•„ -->
      <div class="hero" aria-label="í”„ë¡œí•„">
        <div class="avatar" aria-hidden="true">ğŸ‘¤</div>
        <div>
          <div class="name">@@ë‹˜</div>
          <div class="email">aaa123@gmail.com</div>
        </div>
      </div>

      <!-- ì›” ìš”ì•½ -->
      <section class="summary" aria-label="ì´ë‹¬ ê´€ë¦¬ ìš”ê¸ˆ ìš”ì•½">
        <h2>@@ë‹˜ì˜ <span id="summaryMonth">ì´ë²ˆ ë‹¬</span> ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ <span class="kpi" id="totalPrice">0 ì›</span></h2>
        <p class="small" id="deltaText">ë¹„êµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
        <div class="bars">
          <div class="bar">
            <span class="label">ì§€ë‚œë‹¬</span>
            <div class="track"><div class="fill july" id="barJuly" style="width:50%"></div></div>
          </div>
          <div class="bar">
            <span class="label">ì´ë²ˆë‹¬</span>
            <div class="track"><div class="fill aug" id="barAug" style="width:50%"></div></div>
          </div>
        </div>
      </section>

      <!-- ì¹´ë“œ: ì „ê¸°/ê°€ìŠ¤ -->
      <section class="panel" aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—">
        <h3 style="margin:0 0 12px">ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì— ëª¨ì•„ë³´ê¸° &gt;</h3>
        <div class="cards">
          <article class="card" aria-label="ì „ê¸°">
            <div class="label">âš¡ ì˜ˆìƒ ì „ê¸° ìš”ê¸ˆ</div>
            <div class="kpi" id="elecPrice">0 ì›</div>
            <div class="donut" id="donutElec" style="--percent:0"><div class="center">ì „ê¸° ë¹„ì¤‘</div></div>
          </article>
          <article class="card" aria-label="ê°€ìŠ¤">
            <div class="label">ğŸ”¥ ì˜ˆìƒ ê°€ìŠ¤ ìš”ê¸ˆ</div>
            <div class="kpi" id="gasPrice">0 ì›</div>
            <div class="donut" id="donutGas" style="--percent:0"><div class="center">ê°€ìŠ¤ ë¹„ì¤‘</div></div>
          </article>
        </div>
      </section>

      <!-- ëˆ„ì  ë§‰ëŒ€ì°¨íŠ¸ -->
      <section class="panel">
        <h3>ì´ë²ˆ ë‹¬ ì „ê¸°/ê°€ìŠ¤ ëˆ„ì </h3>
        <div id="chartBars" class="chart-line"></div>
      </section>

      <!-- ì ˆì•½ ëª©í‘œ -->
      <section class="goal-card" aria-label="ì ˆì•½ ëª©í‘œ">
        <div class="goal-head">
          <h3 class="goal-title">ì´ë²ˆ ë‹¬ ì ˆì•½ ëª©í‘œ</h3>
          <span id="goalHint" class="goal-meta">ëª©í‘œë¥¼ ì„¤ì •í•´ ì§„í–‰ë¥ ì„ í™•ì¸í•´ ë³´ì„¸ìš”</span>
        </div>

        <div class="progress">
          <div class="progress-track"><div id="goalFill" class="progress-fill"></div></div>
          <div class="progress-label">
            <span id="savedNow">ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: 0 ì›</span>
            <span id="goalPct">0%</span>
          </div>
        </div>

        <form class="goal-form" id="goalForm">
          <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 30000)" />
          <button type="submit" class="btn">ì €ì¥</button>
          <button type="button" id="goalClear" class="btn">ì´ˆê¸°í™”</button>
        </form>

        <div id="goalSuccess" style="display:none">
          <span class="badge-success">ëª©í‘œ ë‹¬ì„±!</span>
        </div>
      </section>
    </main>

    <!-- Footer Tabs -->
    <footer>
      <div class="tabs" aria-label="íƒ­">
        <a class="tab active" href="home.html" aria-label="í™ˆ">í™ˆ</a>
        <a class="tab" href="analysis.html" aria-label="AI ë¶„ì„">AI</a>
        <a class="tab" href="goals.html" aria-label="ì‹¤ì‹œê°„ ìš”ê¸ˆ">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html" aria-label="ë§ˆì´í˜ì´ì§€">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="ì „ì²´">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <!-- Drawer (ê³µí†µ) -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div>
        <div class="d-name">@@ë‹˜</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
      <a href="#">íƒˆí‡´í•˜ê¸°</a>
    </div>
  </aside>

  <!-- Scripts -->
  <script src="app3.js" defer></script>

  <!-- Drawer ì—´ê³ /ë‹«ê¸° -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr || !sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>

  <!-- âœ… ê³µí†µ í™˜ê²½ê°’ (ì£¼ì†Œ/ì‚¬ìš©ì) -->
  <script>
    // ê¸°ë³¸ê°’(ê°œë°œìš©). ìš´ì˜ì—ì„œëŠ” env.jsë¡œ window.APP_CONFë¥¼ ë¨¼ì € ì •ì˜í•˜ê±°ë‚˜, ì•„ë˜ë¥¼ ë¹ˆ ë¬¸ìì—´("")ë¡œ ë°”ê¾¸ì„¸ìš”.
    window.APP_CONF = window.APP_CONF || {};
    if (!('API_ORIGIN' in window.APP_CONF)) window.APP_CONF.API_ORIGIN = "http://localhost:8080"; // ë°°í¬ í”„ë¡ì‹œë©´ ""
    if (!('USER_ID' in window.APP_CONF))    window.APP_CONF.USER_ID    = 1;
  </script>

  <!-- âœ… 1) ë„ë„› ì°¨íŠ¸ ì—°ë™: GET /api/dashboard/donut?userId=&period=YYYY-MM -->
  <script>
  (async function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const ENDPOINT = (API_ORIGIN || "") + "/api/dashboard/donut";

    const now = new Date();
    const period = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
    document.getElementById("summaryMonth").textContent = `${now.getMonth()+1}ì›”`;

    const isYm = /^\d{4}-(0[1-9]|1[0-2])$/.test(period);
    if (!isYm) return;

    const $elecPrice = document.getElementById("elecPrice");
    const $gasPrice  = document.getElementById("gasPrice");
    const $total     = document.getElementById("totalPrice");
    const $donutElec = document.getElementById("donutElec");
    const $donutGas  = document.getElementById("donutGas");
    const fmt = new Intl.NumberFormat("ko-KR");

    try{
      const url = `${ENDPOINT}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) return; // 400/500ì€ ê·¸ëŒ€ë¡œ ë¬´ì‹œ
      const data = await res.json(); // {periodYm, elec, gas, total, elecRatio, gasRatio}

      if ($elecPrice && typeof data.elec === "number") $elecPrice.textContent = `${fmt.format(data.elec)} ì›`;
      if ($gasPrice  && typeof data.gas  === "number") $gasPrice.textContent  = `${fmt.format(data.gas)} ì›`;
      if ($total     && typeof data.total=== "number") $total.textContent     = `${fmt.format(data.total)} ì›`;

      const elecPct = Math.max(0, Math.min(100, Math.round((data.elecRatio || 0) * 100)));
      const gasPct  = Math.max(0, Math.min(100, Math.round((data.gasRatio  || 0) * 100)));
      if ($donutElec) $donutElec.style.setProperty("--percent", elecPct);
      if ($donutGas)  $donutGas .style.setProperty("--percent", gasPct);
    }catch(e){ /* ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ í™”ë©´ ìœ ì§€ */ }
  })();
  </script>

  <!-- âœ… 2) ëˆ„ì  ë§‰ëŒ€ ì°¨íŠ¸: GET /api/dashboard/bars?userId=&period=YYYY-MM -->
  <script>
  (async function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const ENDPOINT = (API_ORIGIN || "") + "/api/dashboard/bars";

    const now = new Date();
    const period = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
    const isYm = /^\d{4}-(0[1-9]|1[0-2])$/.test(period);
    if (!isYm) return;

    const container = document.getElementById("chartBars") || document.querySelector(".chart-line");
    if (!container) return;

    let data;
    try{
      const url = `${ENDPOINT}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) { container.textContent="ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
      data = await res.json(); // { periodYm, bars:[{day, elecCum, gasCum, totalCum}, ...] }
    }catch(e){ container.textContent="ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"; return; }

    if (!data || !Array.isArray(data.bars) || !data.bars.length) {
      container.textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."; return;
    }

    function draw(){
      container.innerHTML = "";
      const width  = Math.max(240, container.clientWidth || 320);
      const height = 200;
      const M = {top:10,right:10,bottom:24,left:30};
      const iw = width - M.left - M.right;
      const ih = height - M.top - M.bottom;

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width", width); svg.setAttribute("height", height);

      const maxY = data.bars.reduce((m,b)=>Math.max(m, b.totalCum||0), 1);
      const n = data.bars.length;
      const slot = iw / n;
      const barW = Math.max(3, Math.min(20, slot*0.6));
      const baseY = height - M.bottom;

      // grid
      const grid = document.createElementNS(svg.namespaceURI,"g");
      for(let i=1;i<=3;i++){
        const y = M.top + ih * i / 4;
        const line = document.createElementNS(svg.namespaceURI,"line");
        line.setAttribute("x1", M.left); line.setAttribute("y1", y);
        line.setAttribute("x2", width-M.right); line.setAttribute("y2", y);
        line.setAttribute("stroke","rgba(0,0,0,.08)");
        grid.appendChild(line);
      }
      svg.appendChild(grid);

      const barsG = document.createElementNS(svg.namespaceURI,"g");
      data.bars.forEach((b,i)=>{
        const xCenter = M.left + i*slot + slot/2;
        const x = xCenter - barW/2;

        const totalH = ih * (Math.max(0,b.totalCum||0) / maxY);
        const elecH  = ih * (Math.max(0,b.elecCum ||0)  / maxY);
        const gasH   = Math.max(0, totalH - elecH);

        const r1 = document.createElementNS(svg.namespaceURI,"rect"); // gas
        r1.setAttribute("x",x); r1.setAttribute("y", baseY-gasH);
        r1.setAttribute("width",barW); r1.setAttribute("height",gasH);
        r1.setAttribute("fill","#f97316"); r1.setAttribute("rx","2");
        barsG.appendChild(r1);

        const r2 = document.createElementNS(svg.namespaceURI,"rect"); // elec
        r2.setAttribute("x",x); r2.setAttribute("y", baseY-totalH);
        r2.setAttribute("width",barW); r2.setAttribute("height",elecH);
        r2.setAttribute("fill","#facc15"); r2.setAttribute("rx","2");
        barsG.appendChild(r2);

        if (b.day % 5 === 0 || i===0 || i===n-1){
          const t = document.createElementNS(svg.namespaceURI,"text");
          t.setAttribute("x", xCenter); t.setAttribute("y", baseY+14);
          t.setAttribute("text-anchor","middle"); t.setAttribute("font-size","10");
          t.setAttribute("fill","rgba(0,0,0,.55)"); t.textContent = b.day;
          barsG.appendChild(t);
        }
      });
      svg.appendChild(barsG);

      // legend
      const lg = document.createElementNS(svg.namespaceURI,"g");
      [["#facc15","ì „ê¸° ëˆ„ì "],["#f97316","ê°€ìŠ¤ ëˆ„ì "]].forEach((it,idx)=>{
        const x = width - M.right - 120 + idx*60, y = M.top+10;
        const s = document.createElementNS(svg.namespaceURI,"rect");
        s.setAttribute("x",x); s.setAttribute("y",y-8); s.setAttribute("width",10); s.setAttribute("height",10);
        s.setAttribute("fill",it[0]); s.setAttribute("rx","2");
        const tx = document.createElementNS(svg.namespaceURI,"text");
        tx.setAttribute("x",x+14); tx.setAttribute("y",y); tx.setAttribute("font-size","10"); tx.textContent=it[1];
        tx.setAttribute("fill","rgba(0,0,0,.6)");
        lg.appendChild(s); lg.appendChild(tx);
      });
      svg.appendChild(lg);

      container.appendChild(svg);
    }
    draw();
    let t; window.addEventListener("resize", ()=>{ clearTimeout(t); t=setTimeout(draw,120); });
  })();
  </script>

  <!-- âœ… 3) ì ˆì•½ ëª©í‘œ ì €ì¥: POST /api/dashboard/goal  &  ì¡°íšŒ: GET /api/dashboard/goal -->
  <script>
  // ì €ì¥(POST)
  (function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const API_URL = (API_ORIGIN || "") + "/api/dashboard/goal";

    const d = document;
    const form    = d.getElementById("goalForm");
    const input   = d.getElementById("goalInput");
    const hintEl  = d.getElementById("goalHint");
    const pctEl   = d.getElementById("goalPct");
    const fillEl  = d.getElementById("goalFill");
    const savedEl = d.getElementById("savedNow");
    const badge   = d.getElementById("goalSuccess");
    const fmt = new Intl.NumberFormat("ko-KR");

    if (!form) return;

    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const ym = ()=>{ const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0"); };

    function msg(t,err){ if(!hintEl) return; hintEl.textContent=t; hintEl.style.color = err ? "#e11d48" : ""; }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const val = Number(input.value);
      if (!Number.isFinite(val) || val < 0){ msg("ëª©í‘œ ê¸ˆì•¡ì„ 0 ì´ìƒ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true); return; }

      const body = { userId: USER_ID, periodYm: ym(), savingGoalWon: Math.round(val) };
      if (!/^\d{4}-(0[1-9]|1[0-2])$/.test(body.periodYm)){ msg("ê¸°ê°„ í˜•ì‹(YYYY-MM)ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", true); return; }

      try{
        const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if (res.status === 400){ msg("ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜: ê¸°ê°„ ë˜ëŠ” ê¸ˆì•¡ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", true); return; }
        if (!res.ok){ msg("ì„œë²„ ì˜¤ë¥˜ë¡œ ì €ì¥í•˜ì§€ ëª»í–ˆì–´ìš”.", true); return; }

        const data = await res.json(); // GoalResponse
        const baseline = Number(data.baselineTotalWon || 0);
        const current  = Number(data.currentTotalWon  || 0);
        const saved    = Math.max(0, baseline - current);
        const percent  = clamp(Number(data.savingPercent || 0), 0, 100);

        if (savedEl) savedEl.textContent = `ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: ${fmt.format(saved)} ì›`;
        if (pctEl)   pctEl.textContent   = `${percent.toFixed(1)}%`;
        if (fillEl)  fillEl.style.width  = `${percent}%`;
        if (badge)   badge.style.display = percent>=100 ? "block" : "none";

        msg(`ëª©í‘œ ${fmt.format(data.savingGoalWon)} ì› ì €ì¥ ì™„ë£Œ!`);
      }catch(e){ msg("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì €ì¥í•˜ì§€ ëª»í–ˆì–´ìš”.", true); }
    });

    d.getElementById("goalClear")?.addEventListener("click", ()=>{
      if (pctEl)   pctEl.textContent = "0%";
      if (fillEl)  fillEl.style.width="0%";
      if (savedEl) savedEl.textContent="ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: 0 ì›";
      if (input)   input.value="";
      msg("ëª©í‘œë¥¼ ì„¤ì •í•´ ì§„í–‰ë¥ ì„ í™•ì¸í•´ ë³´ì„¸ìš”", false);
      if (badge)   badge.style.display="none";
    });
  })();

  // ì¡°íšŒ(GET) + ìš”ì•½(ìƒë‹¨ ì´ì•¡/ì¦ê°, ë§‰ëŒ€ ë„ˆë¹„)ë„ ê°™ì´ ê°±ì‹ 
  (function () {
    const { API_ORIGIN, USER_ID } = window.APP_CONF;
    const API_URL = (API_ORIGIN || "") + "/api/dashboard/goal";

    const d = document;
    const input   = d.getElementById("goalInput");
    const hintEl  = d.getElementById("goalHint");
    const pctEl   = d.getElementById("goalPct");
    const fillEl  = d.getElementById("goalFill");
    const savedEl = d.getElementById("savedNow");
    const badge   = d.getElementById("goalSuccess");

    // ì›” ìš”ì•½ì— ìˆëŠ” ìš”ì†Œë“¤
    const totalEl = d.getElementById("totalPrice");
    const deltaEl = d.getElementById("deltaText");
    const barJuly = d.getElementById("barJuly");
    const barAug  = d.getElementById("barAug");

    const fmt = new Intl.NumberFormat("ko-KR");
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const ym = ()=>{ const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0"); };
    function msg(t,err){ if(!hintEl) return; hintEl.textContent=t; hintEl.style.color = err ? "#e11d48" : ""; }

    async function fetchGoal(){
      const period = ym();
      if (!/^\d{4}-(0[1-9]|1[0-2])$/.test(period)){ msg("ê¸°ê°„ í˜•ì‹(YYYY-MM)ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", true); return; }

      const url = `${API_URL}?userId=${encodeURIComponent(USER_ID)}&period=${encodeURIComponent(period)}`;
      try{
        const res = await fetch(url);
        if (res.status === 204){ msg("ëª©í‘œë¥¼ ì„¤ì •í•´ ì§„í–‰ë¥ ì„ í™•ì¸í•´ ë³´ì„¸ìš”"); return; }
        if (res.status === 400){ msg("ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜: ê¸°ê°„(YYYY-MM)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", true); return; }
        if (!res.ok){ msg("ì„œë²„ ì˜¤ë¥˜ë¡œ ëª©í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.", true); return; }

        const data = await res.json(); // GoalResponse
        const target   = Number(data.savingGoalWon || 0);
        const baseline = Number(data.baselineTotalWon || 0); // ì§€ë‚œë‹¬ ì´ì•¡
        const current  = Number(data.currentTotalWon  || 0); // ì´ë²ˆë‹¬ ì´ì•¡
        const saved    = Math.max(0, baseline - current);
        const percent  = clamp(Number(data.savingPercent || ((baseline>0)? (baseline-current)/baseline*100 : 0)), 0, 100);

        if (input)   input.value = target ? String(target) : "";
        if (savedEl) savedEl.textContent = `ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: ${fmt.format(saved)} ì›`;
        if (pctEl)   pctEl.textContent   = `${percent.toFixed(1)}%`;
        if (fillEl)  fillEl.style.width  = `${percent}%`;
        if (badge)   badge.style.display = percent>=100 ? "block" : "none";
        msg(`ëª©í‘œ: ${fmt.format(target)} ì› Â· ë‚¨ì€ ê¸ˆì•¡ ${fmt.format(Math.max(0,target - saved))} ì›`);

        // ìƒë‹¨ ìš”ì•½ë„ í•¨ê»˜ ê°±ì‹  (ì´ì•¡/ì¦ê°/ë§‰ëŒ€ ë„ˆë¹„)
        if (totalEl) totalEl.textContent = `${fmt.format(current)} ì›`;
        if (baseline>0 && deltaEl){
          const diffPct = ((current - baseline) / baseline) * 100;
          const absPct  = Math.abs(diffPct).toFixed(1);
          deltaEl.textContent = diffPct<=0
            ? `ì§€ë‚œë‹¬ ë³´ë‹¤ ${absPct}% ë‚®ì€ ê¸ˆì•¡ì´ì—ìš”!`
            : `ì§€ë‚œë‹¬ ë³´ë‹¤ ${absPct}% ë†’ì€ ê¸ˆì•¡ì´ì—ìš”!`;
        }else if(deltaEl){
          deltaEl.textContent = "ë¹„êµí•  ì§€ë‚œë‹¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
        if (barJuly && barAug){
          const max = Math.max(baseline, current, 1);
          barJuly.style.width = `${Math.round(baseline/max*100)}%`;
          barAug .style.width = `${Math.round(current /max*100)}%`;
        }
      }catch(e){ msg("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ëª©í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.", true); }
    }

    document.addEventListener("DOMContentLoaded", fetchGoal);
  })();
  </script>

</body>
</html>
