<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•Œë¦¼</title>
  <link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />

  <!-- âœ… alerts í˜ì´ì§€ ì „ìš©: ì œëª© 1ì¤„ + ë‘¥ê·¼ ë°°ì§€ ì˜¤ë²„ë¼ì´ë“œ -->
  <style>
    /* ì œëª©ì„ í•­ìƒ í•œ ì¤„ë¡œ (ë„˜ì¹˜ë©´ â€¦ ì²˜ë¦¬, ì‚´ì§ ì‘ì€ í¬ê¸°) */
    body[data-page="alerts"] .list-item .title{
      font-size: var(--fs-14);
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.2px;
      line-height: 1.25;
      display:inline-block;
      max-width: 100%;
    }

    /* ë°°ì§€ ë” ë‘¥ê¸€ê³  ë¶€ë“œëŸ½ê²Œ */
    body[data-page="alerts"] .badge{
      border: none !important;
      border-radius: 9999px !important;
      padding: 6px 12px !important;
      font-size: var(--fs-12) !important;
      line-height: 1 !important;
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.04),
        0 2px 6px rgba(15,23,42,.06);
    }
    body[data-page="alerts"] .badge.info{
      background: rgba(59,130,246,.14) !important; /* íŒ */
      color: #0ea5e9 !important;
    }
    body[data-page="alerts"] .badge.warn{
      background: rgba(234,88,12,.14) !important;  /* ì•Œë¦¼ */
      color: #f97316 !important;
    }
  </style>
  <style>
  /* alerts: ì•„ì´ì½˜ ì˜† í…ìŠ¤íŠ¸ì—ë§Œ ì‚´ì§ ì™¼ìª½ ì—¬ë°± ë¶€ì—¬ */
  body[data-page="alerts"] .list-item > div:nth-of-type(2){
    padding-left: 8px; /* í•„ìš”í•˜ë©´ 6~12px ì‚¬ì´ë¡œë§Œ ì¡°ì ˆ */
  }
</style>

</head>
<body data-page="alerts">
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="top-bar">
        <div class="time">--:--</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="index.html">í™ˆ</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="section stack">
      <div class="list">
        <article class="list-item">
          <div class="icon">ğŸ””</div>
          <div>
            <div><strong class="title">ëŒ€ê¸°ì „ë ¥ ì ˆê°: ë©€í‹°íƒ­ ìŠ¤ì¼€ì¤„ OFF ì¶”ì²œ</strong></div>
            <div class="small">2ì¼ ì „ Â· ì ˆì•½ íŒ</div>
          </div>
          <span class="badge info">íŒ</span>
        </article>

        <article class="list-item">
          <div class="icon">ğŸ””</div>
          <div>
            <div><strong class="title">ì„¼ì„œ ì—°ê²° ìƒíƒœê°€ ì ì‹œ ë¶ˆì•ˆì •</strong></div>
            <div class="small">3ì¼ ì „ Â· ì‹œìŠ¤í…œ</div>
          </div>
          <span class="badge warn">ì•Œë¦¼</span>
        </article>
      </div>

      <section class="stats-card">
        <h3 style="margin:0 0 10px">ì´ë²ˆ ë‹¬ ì•Œë¦¼ í†µê³„</h3>
        <div class="stat-grid">
          <div class="stat"><div class="emoji">ğŸ””</div><div class="value">6</div><div class="label">ì „ì²´</div></div>
          <div class="stat"><div class="emoji">âœ…</div><div class="value">5</div><div class="label">í™•ì¸</div></div>
          <div class="stat"><div class="emoji">âš ï¸</div><div class="value">2</div><div class="label">ì£¼ì˜</div></div>
          <div class="stat"><div class="emoji">ğŸ’¡</div><div class="value">4</div><div class="label">ì ˆì•½ íŒ</div></div>
          <div class="stat"><div class="emoji">â„¹ï¸</div><div class="value">0</div><div class="label">ì•ˆë‚´</div></div>
        </div>
      </section>
    </main>

    <!-- Tabs -->
    <footer>
      <div class="tabs">
        <a class="tab" href="index.html">í™ˆ</a>
        <a class="tab" href="analysis.html">AI</a>
        <a class="tab" href="goals.html">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <!-- Drawer (ê³µí†µ) -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div><div class="d-name">@@ë‹˜</div><div class="d-email">aaa123@gmail.com</div></div>
    </div>
    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>
    <div class="d-hr"></div>
    <div class="d-actions"><a href="#">ë¡œê·¸ì•„ì›ƒ</a><a href="#">íƒˆí‡´í•˜ê¸°</a></div>
  </aside>

  <!-- Drawer script -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      const open=()=>{dr.classList.add('open'); sc.classList.add('show');};
      const close=()=>{dr.classList.remove('open'); sc.classList.remove('show');};
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
  <!-- ê° í˜ì´ì§€(<head> or </body> ë)ì— ì¶”ê°€ -->
    <!-- api.js -->
<script>
// â˜… ì„œë²„ ì£¼ì†Œë§Œ ë„ˆí¬ í™˜ê²½ì— ë§ê²Œ ë°”ê¾¸ë©´ ë¨
const BASE_URL = 'http://localhost:8080';

// ê³µí†µ GET/POST ë„ìš°ë¯¸ (ì¤‘í•™ìƒ ì„¤ëª…)
// - get(): url?ì¿¼ë¦¬=ê°’ í˜•íƒœë¡œ í˜¸ì¶œ
// - post(): JSON ë°”ë””ë¡œ í˜¸ì¶œ
async function _get(path, params = {}) {
  const url = new URL(BASE_URL + path);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  const res = await fetch(url, { headers: { Accept: 'application/json' } });
  if (!res.ok) throw new Error(`GET ${url} -> ${res.status}`);
  return res.json();
}
async function _post(path, body = {}) {
  const res = await fetch(BASE_URL + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(`POST ${path} -> ${res.status}`);
  return res.json();
}

// ===== ì•Œë¦¼ API ë¬¶ìŒ =====
const api = {
  // 1) SSE êµ¬ë…: /api/alerts/stream?userId=1
  // - ì„œë²„ê°€ ë³´ë‚´ëŠ” ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ëª…:
  //   â€¢ "connected" : ì—°ê²° ì„±ê³µ
  //   â€¢ "alert"     : ì•Œë¦¼ ë„ì°© (payload: ì•„ë˜ addAlertRowì—ì„œ ì“°ëŠ” JSON)
  // - handlers = { onOpen, onAlert, onError }
  subscribeAlerts(userId, handlers = {}) {
    const url = new URL(BASE_URL + '/api/alerts/stream');
    url.searchParams.set('userId', userId);

    // EventSource: ì„œë²„ê°€ ê³„ì† "í‘¸ì‹œ"í•˜ëŠ” ì „ìš© ì—°ê²°
    const es = new EventSource(url);

    es.addEventListener('connected', (e) => {
      handlers.onOpen?.(e);
    });
    es.addEventListener('alert', (e) => {
      try {
        const data = JSON.parse(e.data);
        handlers.onAlert?.(data);
      } catch (err) {
        console.error('alert payload JSON íŒŒì‹± ì‹¤íŒ¨', err, e.data);
      }
    });
    es.onerror = (e) => {
      handlers.onError?.(e);
      // ë„¤íŠ¸ì›Œí¬ê°€ ì ê¹ ëŠê²¨ë„ EventSourceê°€ ìë™ ì¬ì‹œë„ í•¨
      // (ì›í•˜ë©´ es.close() í•˜ê³ , setTimeoutìœ¼ë¡œ ì¬êµ¬ë… ë¡œì§ì„ ì§ì ‘ ì§œë„ ë¨)
    };

    return es; // í•„ìš” ì‹œ .close() í˜¸ì¶œí•´ì„œ êµ¬ë… ì¢…ë£Œ
  },

  // 2) ì´ìƒì§•í›„ ì•Œë¦¼ ìƒì„±: POST /api/alerts/anomaly
  //   body ì˜ˆì‹œ: { userId:1, category:"ELECTRICITY", level:"WARN", title:"15ë¶„ ê¸‰ì¦ ê°ì§€", at:null }
  createAnomalyAlert(body) {
    return _post('/api/alerts/anomaly', body);
  },

  // 3) ì•ˆ ì½ì€ ê°œìˆ˜: GET /api/alerts/unread-count?userId=1
  getUnreadCount(userId) {
    return _get('/api/alerts/unread-count', { userId });
  },
};

window.api = api; // ì „ì—­ì—ì„œ window.apië¡œ ì ‘ê·¼
</script>
<!-- app3.js (ë§¨ ì•„ë˜ìª½ì— ë¶™ì—¬ ë„£ê¸°) -->
<script>
// â˜… ë¡œê·¸ì¸ ìœ ì € ì•„ì´ë””ë§Œ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¿” ì“°ì„¸ìš”
const USER_ID = 1;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ì•Œë¦¼ ì•„ì´ì½˜ ë±ƒì§€(ì•ˆ ì½ì€ ê°œìˆ˜)
 * - í˜ì´ì§€ ë¡œë“œ ì‹œ 1ë²ˆë§Œ ì¡°íšŒí•´ì„œ ì‘ê²Œ í‘œì‹œ
 * - HTMLì„ ì•ˆ ë°”ê¿”ë„ JSë¡œ ìš”ì†Œë¥¼ ë§Œë“¤ì–´ì„œ ë¶™ì…ë‹ˆë‹¤.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function paintBellUnread() {
  try {
    const count = await window.api.getUnreadCount(USER_ID);
    const bell = document.querySelector('.top-actions a[aria-label="ì•Œë¦¼"]');
    if (!bell) return;

    // ê¸°ì¡´ ë°°ì§€ ì œê±°
    bell.querySelector('.bell-badge')?.remove();

    if (count > 0) {
      // ì‘ì€ ë™ê·¸ë¼ë¯¸ ìˆ«ì
      const badge = document.createElement('span');
      badge.className = 'bell-badge';
      Object.assign(badge.style, {
        position: 'absolute',
        top: '-4px',
        right: '-4px',
        minWidth: '16px',
        height: '16px',
        padding: '0 4px',
        borderRadius: '999px',
        background: '#ef4444',
        color: '#fff',
        fontSize: '11px',
        lineHeight: '16px',
        textAlign: 'center',
        boxShadow: '0 1px 2px rgba(0,0,0,.2)',
      });
      badge.textContent = String(count);
      // ë¶€ëª¨(anchor)ë¥¼ ìƒëŒ€ ìœ„ì¹˜ë¡œ
      bell.style.position = 'relative';
      bell.appendChild(badge);
    }
  } catch (e) {
    console.warn('ì•ˆì½ì€ ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨', e);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ì•Œë¦¼ ëª©ë¡ í˜ì´ì§€: SSE êµ¬ë…
 * - body[data-page="alerts"]ì—ì„œë§Œ ì‹¤í–‰
 * - ì„œë²„ê°€ ë³´ë‚´ëŠ” alert payload ì˜ˆ:
 *   { userId:1, category:"BILL", level:"INFO", title:"8ì›” ì „ê¸°ìš”ê¸ˆ 5% ì¦ê°€", at:"2025-08-17T17:10:12.123" }
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initAlertsSSE() {
  if (document.body.dataset.page !== 'alerts') return;

  const list = document.querySelector('.list');

  function addAlertRow(a) {
    // level â†’ ë°°ì§€ ìƒ‰ (ë””ìì¸ì€ ê¸°ì¡´ í´ë˜ìŠ¤ ì¬ì‚¬ìš©)
    const levelToClass = {
      INFO: 'info',
      WARN: 'warn',
      CRIT: 'warn',
    };
    const badgeClass = levelToClass[a.level] || 'info';
    const when = a.at ? new Date(a.at).toLocaleString() : 'ë°©ê¸ˆ ì „';

    // ê¸°ì¡´ ì¹´ë“œ ìŠ¤íƒ€ì¼ì— ë§ì¶° article ìƒì„± (HTML êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ)
    const item = document.createElement('article');
    item.className = 'list-item';
    item.innerHTML = `
      <div class="icon">ğŸ””</div>
      <div>
        <div><strong class="title">${escapeHtml(a.title || 'ì•Œë¦¼')}</strong></div>
        <div class="small">${when} Â· ${a.category || 'ì•Œë¦¼'}</div>
      </div>
      <span class="badge ${badgeClass}">${a.level || 'INFO'}</span>
    `;
    list?.prepend(item); // ìƒˆ ì•Œë¦¼ì´ ìœ„ë¡œ ì˜¤ê²Œ
  }

  // XSS ë°©ì§€ìš© ì•„ì£¼ ê°„ë‹¨í•œ ì´ìŠ¤ì¼€ì´í”„
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;',
    }[c]));
  }

  // êµ¬ë… ì‹œì‘
  window.api.subscribeAlerts(USER_ID, {
    onOpen: () => console.log('SSE ì—°ê²°ë¨'),
    onAlert: (payload) => {
      addAlertRow(payload);
      // ìƒˆ ì•Œë¦¼ì´ ì™”ìœ¼ë‹ˆ ì•„ì´ì½˜ ë°°ì§€ë„ ê°±ì‹ 
      paintBellUnread();
    },
    onError: (e) => console.warn('SSE ì˜¤ë¥˜', e),
  });
}

/* ì´ˆê¸°í™” */
document.addEventListener('DOMContentLoaded', () => {
  paintBellUnread();
  initAlertsSSE();
});
</script>
<script src="api.js" defer></script>
<script src="app3.js" defer></script>
</body>
</html>
