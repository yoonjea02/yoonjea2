<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•Œë¦¼</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <script src="env.js"></script>

  <!-- alerts ì „ìš© ì‚´ì§ ìŠ¤íƒ€ì¼(ë ˆì´ì•„ì›ƒ ì˜í–¥ ì—†ìŒ) -->
  <style>
    body[data-page="alerts"] .list-item .title{ font-size: var(--fs-14); font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.2px; line-height: 1.25; display:inline-block; max-width: 100%; }
    body[data-page="alerts"] .badge{ border:none!important; border-radius:9999px!important; padding:6px 12px!important; font-size:var(--fs-12)!important; line-height:1!important; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04), 0 2px 6px rgba(15,23,42,.06); }
    body[data-page="alerts"] .badge.info{ background: rgba(59,130,246,.14)!important; color:#0ea5e9!important; }
    body[data-page="alerts"] .badge.warn{ background: rgba(234,88,12,.14)!important;  color:#f97316!important; }
    body[data-page="alerts"] .list-item > div:nth-of-type(2){ padding-left: 8px; }
  </style>
</head>
<body data-page="alerts">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">--:--</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="index.html">í™ˆ</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <div class="list" id="alertList">
        <!-- ê¸°ì¡´ ì˜ˆì‹œ 2ê°œ ìœ ì§€: ìƒˆ ì•Œë¦¼ì€ ìœ„ì— prepend ë©ë‹ˆë‹¤ -->
        <article class="list-item">
          <div class="icon">ğŸ””</div>
          <div>
            <div><strong class="title">ëŒ€ê¸°ì „ë ¥ ì ˆê°: ë©€í‹°íƒ­ ìŠ¤ì¼€ì¤„ OFF ì¶”ì²œ</strong></div>
            <div class="small">2ì¼ ì „ Â· ì ˆì•½ íŒ</div>
          </div>
          <span class="badge info">íŒ</span>
        </article>

        <article class="list-item">
          <div class="icon">ğŸ””</div>
          <div>
            <div><strong class="title">ì„¼ì„œ ì—°ê²° ìƒíƒœê°€ ì ì‹œ ë¶ˆì•ˆì •</strong></div>
            <div class="small">3ì¼ ì „ Â· ì‹œìŠ¤í…œ</div>
          </div>
          <span class="badge warn">ì•Œë¦¼</span>
        </article>
      </div>

      <section class="stats-card">
        <h3 style="margin:0 0 10px">ì´ë²ˆ ë‹¬ ì•Œë¦¼ í†µê³„</h3>
        <div class="stat-grid">
          <div class="stat"><div class="emoji">ğŸ””</div><div class="value">6</div><div class="label">ì „ì²´</div></div>
          <div class="stat"><div class="emoji">âœ…</div><div class="value">5</div><div class="label">í™•ì¸</div></div>
          <div class="stat"><div class="emoji">âš ï¸</div><div class="value">2</div><div class="label">ì£¼ì˜</div></div>
          <div class="stat"><div class="emoji">ğŸ’¡</div><div class="value">4</div><div class="label">ì ˆì•½ íŒ</div></div>
          <div class="stat"><div class="emoji">â„¹ï¸</div><div class="value">0</div><div class="label">ì•ˆë‚´</div></div>
        </div>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html">í™ˆ</a>
        <a class="tab" href="analysis.html">AI</a>
        <a class="tab" href="goals.html">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <!-- Drawer -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div><div class="d-name">@@ë‹˜</div><div class="d-email">aaa123@gmail.com</div></div>
    </div>
    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>
    <div class="d-hr"></div>
    <div class="d-actions"><a href="#">ë¡œê·¸ì•„ì›ƒ</a><a href="#">íƒˆí‡´í•˜ê¸°</a></div>
  </aside>

  <!-- API ì—°ê²° -->
  <script>
    (function(){
      const { API_ORIGIN='', USER_ID } = window.__ENV;

      // ë¯¸ì½ìŒ ì¹´ìš´íŠ¸ â†’ ì•Œë¦¼ ì•„ì´ì½˜ ë°°ì§€
      async function paintBellUnread() {
        try {
          const res = await fetch(`${API_ORIGIN}/api/alerts/unread-count?userId=${USER_ID}`);
          if (!res.ok) return;
          const count = await res.json(); // ìˆ«ì
          const bell = document.querySelector('.top-actions a[aria-label="ì•Œë¦¼"]');
          if (!bell) return;
          bell.querySelector('.bell-badge')?.remove();
          if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'bell-badge';
            Object.assign(badge.style, { position:'absolute', top:'-4px', right:'-4px', minWidth:'16px', height:'16px', padding:'0 4px', borderRadius:'999px', background:'#ef4444', color:'#fff', fontSize:'11px', lineHeight:'16px', textAlign:'center', boxShadow:'0 1px 2px rgba(0,0,0,.2)' });
            badge.textContent = String(count);
            bell.style.position = 'relative';
            bell.appendChild(badge);
          }
        } catch {}
      }

      // SSE êµ¬ë…
      function initSSE(){
        if (document.body.dataset.page !== 'alerts') return;
        const list = document.getElementById('alertList');
        const es = new EventSource(`${API_ORIGIN}/api/alerts/stream?userId=${USER_ID}`);

        function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));}

        es.addEventListener('connected', ()=>console.log('SSE connected'));
        es.addEventListener('alert', (e)=>{
          try{
            const a = JSON.parse(e.data);
            const levelToClass = { INFO:'info', WARN:'warn', CRIT:'warn' };
            const when = a.at ? new Date(a.at).toLocaleString() : 'ë°©ê¸ˆ ì „';
            const item = document.createElement('article');
            item.className = 'list-item';
            item.innerHTML = `
              <div class="icon">ğŸ””</div>
              <div>
                <div><strong class="title">${escapeHtml(a.title||'ì•Œë¦¼')}</strong></div>
                <div class="small">${when} Â· ${escapeHtml(a.category||'ì•Œë¦¼')}</div>
              </div>
              <span class="badge ${levelToClass[a.level]||'info'}">${escapeHtml(a.level||'INFO')}</span>
            `;
            list?.prepend(item);
            paintBellUnread();
          }catch(err){ console.warn('alert payload parse fail', err); }
        });
        es.onerror = e => console.warn('SSE error', e);
      }

      document.addEventListener('DOMContentLoaded', ()=>{ paintBellUnread(); initSSE(); });
    })();
  </script>

  <!-- Drawer script -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      const open=()=>{dr.classList.add('open'); sc.classList.add('show');};
      const close=()=>{dr.classList.remove('open'); sc.classList.remove('show');};
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
</body>
</html>
