<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI ë¶„ì„</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Pretendard Variable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
</head>
<body data-page="analytics">
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="top-bar">
        <div class="time">19:31</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="section stack">

      <!-- âœ… ì´ ì¹´ë“œë§Œ ê¸°ëŠ¥ ì¶”ê°€ (í™˜ê²½ ì„ íƒ) -->
      <section class="insight">
        <h3>ê·¸ë¦°ë£¨í‹´ì´ ë³¸ @@ë‹˜ì€...</h3>

        <!-- ìƒí™œí™˜ê²½ ì„ íƒ -->
        <form id="envForm" class="env-form" aria-label="ìƒí™œí™˜ê²½ ì„ íƒ">
          <label class="env-field">
            <span class="label">ì£¼ê±°í˜•íƒœ</span>
            <select id="envHousing" required>
              <option value="">ì„ íƒ</option>
              <option value="ì›ë£¸">ì›ë£¸</option>
              <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
              <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
              <option value="ë¹Œë¼/ë‹¤ê°€êµ¬">ë¹Œë¼/ë‹¤ê°€êµ¬</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì´ì¤‘ë¬¸</span>
            <select id="envDoors" required>
              <option value="">ì„ íƒ</option>
              <option value="ìˆìŒ">ìˆìŒ</option>
              <option value="ì—†ìŒ">ì—†ìŒ</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì°½í˜¸</span>
            <select id="envWindows" required>
              <option value="">ì„ íƒ</option>
              <option value="ë‹¨ì°½">ë‹¨ì°½</option>
              <option value="ì´ì¤‘ì°½">ì´ì¤‘ì°½</option>
              <option value="ë¡œì´/ë‹¨ì—´">ë¡œì´/ë‹¨ì—´</option>
            </select>
          </label>

          <button type="submit" class="btn env-save">ì €ì¥</button>
        </form>

        <!-- ì„ íƒ ìš”ì•½(ìë™ ê°±ì‹ ) -->
        <p id="envSummary" class="small" style="margin-top:6px">
          ì„ íƒí•œ í™˜ê²½ì„ ë°”íƒ•ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ê°œì¸í™”í•´ë“œë ¤ìš”.
        </p>
      </section>
      <!-- /insight -->

      <section class="panel">
        <h3>@@ë‹˜ì˜ í•˜ë£¨ ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„</h3>
        <div class="chart-line">ë¼ì¸ ì°¨íŠ¸ ì˜ì—­</div>
      </section>

      <section class="stack" style="gap:12px">
        <!-- â¬‡â¬‡â¬‡  ì—¬ê¸´ ULì— idë§Œ ë¶€ì—¬(í‘œì‹œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) -->
        <article class="tip-card">
          <h4>ì „ê¸°</h4>
          <ul id="elecTips">
            <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
          </ul>
        </article>
        <article class="tip-card">
          <h4>ê°€ìŠ¤</h4>
          <ul id="gasTips">
            <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>
          </ul>
        </article>
      </section>
    </main>

    <!-- Tabs -->
    <footer>
      <div class="tabs">
        <a class="tab" href="index.html" aria-label="í™ˆ">í™ˆ</a>
        <a class="tab active" href="analysis.html" aria-label="AI ë¶„ì„">AI</a>
        <a class="tab" href="goals.html" aria-label="ì‹¤ì‹œê°„ ìš”ê¸ˆ">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html" aria-label="ë§ˆì´í˜ì´ì§€">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="ì „ì²´">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <!-- Drawer (í™ˆê³¼ ë™ì¼í•œ ì½˜í…ì¸ ) -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div>
        <div class="d-name">@@ë‹˜</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
      <a href="#">íƒˆí‡´í•˜ê¸°</a>
    </div>
  </aside>

  <!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="app3.js" defer></script>

  <!-- âœ… í™˜ê²½ ì„ íƒ ì €ì¥/ìš”ì•½ + API ì—°ë™ (POST /api/ai/preference) -->
  <script>
    (function(){
      // â˜…â˜…â˜… ì—¬ê¸° 2ê³³ë§Œ í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ê²Œ ë°”ê¾¸ì„¸ìš” â˜…â˜…â˜…
      const API_ORIGIN = "http://localhost:8080";      // â˜… ìˆ˜ì •: ë°±ì—”ë“œ ì£¼ì†Œ/í¬íŠ¸
      const USER_ID    = 1;                            // â˜… ìˆ˜ì •: ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const ENDPOINT   = API_ORIGIN + "/api/ai/preference";

      const $ = s => document.querySelector(s);
      const form = $('#envForm'); if(!form) return;
      const ho = $('#envHousing');
      const dr = $('#envDoors');
      const wi = $('#envWindows');
      const out = $('#envSummary');
      const KEY = 'envPrefs.v1';

      // APIì—ì„œ í—ˆìš©í•˜ëŠ” ê°’(ì„œë²„ 400 ë°©ì§€ìš©)
      const ALLOWED_HOUSING = ["ì›ë£¸","ì˜¤í”¼ìŠ¤í…”","ì•„íŒŒíŠ¸","ë¹Œë¼","ë‹¤ì£¼íƒ"];
      const ALLOWED_WINDOW  = ["ë‹¨ì°½","ì´ì¤‘ì°½","ë¡œì´","ë‹¨ì—´"];

      // UIê°’â†’APIê°’ ë§¤í•‘
      const mapHousing = v => (v === "ë¹Œë¼/ë‹¤ê°€êµ¬" ? "ë¹Œë¼" : v);
      const mapWindow  = v => (v === "ë¡œì´/ë‹¨ì—´"   ? "ë¡œì´" : v);
      const mapDoor    = v => (v === "ìˆìŒ");

      function render(){
        const h = ho.value || 'ì£¼ê±°í˜•íƒœ ë¯¸ì„ íƒ';
        const d = dr.value || 'ì´ì¤‘ë¬¸ ë¯¸ì„ íƒ';
        const w = wi.value || 'ì°½í˜¸ ë¯¸ì„ íƒ';
        out.textContent = `${h} / ${d} / ${w} ê¸°ì¤€ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ê°œì¸í™”í•´ìš”.`;
        out.style.color = "";
      }

      function load(){
        try{
          const saved = JSON.parse(localStorage.getItem(KEY) || '{}');
          if(saved.housing) ho.value = saved.housing;
          if(saved.doors)   dr.value = saved.doors;
          if(saved.windows) wi.value = saved.windows;
        }catch{}
        render();
      }

      async function postPreference(payload){
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) return;                 // 200 OK
        if (res.status === 400) throw new Error("í˜•ì‹ ì˜¤ë¥˜(400)");
        throw new Error("ì„œë²„ ì˜¤ë¥˜(" + res.status + ")");
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        if (!ho.value || !dr.value || !wi.value) {
          out.textContent = "ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
          out.style.color = "#e11d48";
          return;
        }

        const payload = {
          userId: USER_ID,
          housingType: mapHousing(ho.value),
          hasDoubleDoor: mapDoor(dr.value),
          windowType: mapWindow(wi.value)
        };

        if (!ALLOWED_HOUSING.includes(payload.housingType) ||
            !ALLOWED_WINDOW.includes(payload.windowType)) {
          out.textContent = "í—ˆìš©ë˜ì§€ ì•Šì€ ê°’ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.";
          out.style.color = "#e11d48";
          return;
        }

        out.textContent = "ì €ì¥ ì¤‘â€¦";
        out.style.color = "";

        try{
          await postPreference(payload);
          localStorage.setItem(KEY, JSON.stringify({
            housing: ho.value, doors: dr.value, windows: wi.value, ts: Date.now()
          }));
          render();
          out.textContent = "ì €ì¥ ì™„ë£Œ! ì„ íƒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì¸í™”ë©ë‹ˆë‹¤.";
          window.dispatchEvent(new CustomEvent('env:changed', { detail: payload }));
        }catch(err){
          console.error(err);
          out.style.color = "#e11d48";
          out.textContent = (err.message.includes("í˜•ì‹"))
            ? "ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜: ì„ íƒê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”."
            : "ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì˜¤ë¥˜: ë°±ì—”ë“œê°€ ì‹¤í–‰ ì¤‘ì´ê³  CORSê°€ í—ˆìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
        }
      });

      ['change','input'].forEach(ev=>{
        [ho, dr, wi].forEach(el => el.addEventListener(ev, render));
      });

      document.addEventListener('DOMContentLoaded', load);
    })();

    // ë“œë¡œì–´ ì—´ê³ /ë‹«ê¸° (í˜ì´ì§€ ì§„ì… ì‹œ ë‹«í˜ ìƒíƒœ ë³´ì¥)
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr || !sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>

  <!-- âœ… ë§ì¶¤ íŒ ì¡°íšŒ ì—°ë™ (GET /api/ai/tips) -->
  <script>
    (function(){
      // â˜…â˜…â˜… ì—¬ê¸° 3ê³³ë§Œ í”„ë¡œì íŠ¸ í™˜ê²½ì— ë§ê²Œ ë°”ê¾¸ì„¸ìš” â˜…â˜…â˜…
      const API_ORIGIN  = "http://localhost:8080"; // â˜… ìˆ˜ì •: ë°±ì—”ë“œ ì£¼ì†Œ/í¬íŠ¸
      const USER_ID     = 1;                       // â˜… ìˆ˜ì •: ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
      const ELEC_COUNT  = 3;                       // â˜… ìˆ˜ì •: ì „ê¸° íŒ ê°œìˆ˜
      const GAS_COUNT   = 3;                       // â˜… ìˆ˜ì •: ê°€ìŠ¤ íŒ ê°œìˆ˜
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const $elec = document.getElementById('elecTips');
      const $gas  = document.getElementById('gasTips');
      if (!$elec || !$gas) return;

      function renderList(ul, items){
        ul.innerHTML = "";
        items.forEach(t => {
          const li = document.createElement('li');
          li.textContent = String(t);
          ul.appendChild(li);
        });
      }

      function setLoading(){
        $elec.innerHTML = "<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>";
        $gas.innerHTML  = "<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>";
      }

      async function fetchTips(){
        setLoading();
        const url = `${API_ORIGIN}/api/ai/tips?userId=${encodeURIComponent(USER_ID)}&elecCount=${encodeURIComponent(ELEC_COUNT)}&gasCount=${encodeURIComponent(GAS_COUNT)}`;
        try{
          const res = await fetch(url, { method: "GET" });

          if (res.status === 400) {
            renderList($elec, ["ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
            renderList($gas , ["ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
            return;
          }
          if (!res.ok) {
            renderList($elec, ["ì„œë²„ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
            renderList($gas , ["ì„œë²„ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
            return;
          }

          /* ê¸°ëŒ€ ì‘ë‹µ ì˜ˆì‹œ
            { "ELEC": ["â€¦","â€¦"], "GAS": ["â€¦","â€¦"] }
          */
          const data = await res.json();
          const elecTips = Array.isArray(data.ELEC) ? data.ELEC : [];
          const gasTips  = Array.isArray(data.GAS)  ? data.GAS  : [];

          renderList($elec, elecTips.length ? elecTips : ["ì „ê¸° ì ˆì•½ íŒì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤."]);
          renderList($gas , gasTips.length  ? gasTips  : ["ê°€ìŠ¤ ì ˆì•½ íŒì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤."]);
        }catch(err){
          console.error(err);
          renderList($elec, ["ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
          renderList($gas , ["ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ íŒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."]);
        }
      }

      document.addEventListener('DOMContentLoaded', fetchTips);

      // í™˜ê²½ ë³€ê²½ ì‹œ íŒì„ ë‹¤ì‹œ ë°›ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë¦¬ìŠ¤ë„ˆ ìœ ì§€
      window.addEventListener('env:changed', fetchTips);
    })();
  </script>
</body>
</html>
