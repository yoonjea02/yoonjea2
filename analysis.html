<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI ë¶„ì„</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <script src="env.js"></script>
  <style>
    .chart-line { position: relative; min-height: 220px; }
    .chart-line .chart-empty{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:rgba(0,0,0,.6); font-size:14px; text-align:center; padding:8px; }
    .chart-line .chart-svg{ width:100%; height:100%; display:block; }
  </style>
</head>
<body data-page="analytics">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">19:31</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <!-- í™˜ê²½ ì„ íƒ -->
      <section class="insight">
        <h3>ê·¸ë¦°ë£¨í‹´ì´ ë³¸ @@ë‹˜ì€...</h3>

        <form id="envForm" class="env-form" aria-label="ìƒí™œí™˜ê²½ ì„ íƒ">
          <label class="env-field">
            <span class="label">ì£¼ê±°í˜•íƒœ</span>
            <select id="envHousing" required>
              <option value="">ì„ íƒ</option>
              <option value="ì›ë£¸">ì›ë£¸</option>
              <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
              <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
              <option value="ë¹Œë¼/ë‹¤ê°€êµ¬">ë¹Œë¼/ë‹¤ê°€êµ¬</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì´ì¤‘ë¬¸</span>
            <select id="envDoors" required>
              <option value="">ì„ íƒ</option>
              <option value="ìˆìŒ">ìˆìŒ</option>
              <option value="ì—†ìŒ">ì—†ìŒ</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì°½í˜¸</span>
            <select id="envWindows" required>
              <option value="">ì„ íƒ</option>
              <option value="ë‹¨ì°½">ë‹¨ì°½</option>
              <option value="ì´ì¤‘ì°½">ì´ì¤‘ì°½</option>
              <option value="ë¡œì´/ë‹¨ì—´">ë¡œì´/ë‹¨ì—´</option>
            </select>
          </label>

          <button type="submit" class="btn env-save">ì €ì¥</button>
        </form>

        <p id="envSummary" class="small" style="margin-top:6px">
          ì„ íƒí•œ í™˜ê²½ì„ ë°”íƒ•ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ê°œì¸í™”í•´ë“œë ¤ìš”.
        </p>
      </section>

      <!-- ë¼ì¸ì°¨íŠ¸ -->
      <section class="panel">
        <h3>@@ë‹˜ì˜ í•˜ë£¨ ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„</h3>
        <div class="chart-line">ë¼ì¸ ì°¨íŠ¸ ì˜ì—­</div>
      </section>

      <!-- ë§ì¶¤ íŒ -->
      <section class="stack" style="gap:12px">
        <article class="tip-card">
          <h4>ì „ê¸°</h4>
          <ul id="elecTips"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li></ul>
        </article>
        <article class="tip-card">
          <h4>ê°€ìŠ¤</h4>
          <ul id="gasTips"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li></ul>
        </article>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html" aria-label="í™ˆ">í™ˆ</a>
        <a class="tab active" href="analysis.html" aria-label="AI ë¶„ì„">AI</a>
        <a class="tab" href="goals.html" aria-label="ì‹¤ì‹œê°„ ìš”ê¸ˆ">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html" aria-label="ë§ˆì´í˜ì´ì§€">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="ì „ì²´">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div>
        <div class="d-name">@@ë‹˜</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
      <a href="#">íƒˆí‡´í•˜ê¸°</a>
    </div>
  </aside>

  <!-- í™˜ê²½ ì €ì¥(POST /api/ai/preference) + ì €ì¥ ì„±ê³µì‹œ íŒ GET -->
  <script>
    (function(){
      const { API_ORIGIN='', USER_ID } = window.__ENV;
      const $ = s => document.querySelector(s);

      const form = $('#envForm'); if(!form) return;
      const ho = $('#envHousing'), dr = $('#envDoors'), wi = $('#envWindows');
      const out = $('#envSummary');
      const KEY = 'envPrefs.v1';

      const ALLOWED_HOUSING = ["ì›ë£¸","ì˜¤í”¼ìŠ¤í…”","ì•„íŒŒíŠ¸","ë¹Œë¼","ë‹¤ì£¼íƒ"];
      const ALLOWED_WINDOW  = ["ë‹¨ì°½","ì´ì¤‘ì°½","ë¡œì´","ë‹¨ì—´"];
      const mapHousing = v => (v==="ë¹Œë¼/ë‹¤ê°€êµ¬"?"ë¹Œë¼":v);
      const mapWindow  = v => (v==="ë¡œì´/ë‹¨ì—´"  ?"ë¡œì´" :v);
      const mapDoor    = v => (v==="ìˆìŒ");

      function renderSummary(){
        const h = ho.value || "ì£¼ê±°í˜•íƒœ ë¯¸ì„ íƒ";
        const d = dr.value || "ì´ì¤‘ë¬¸ ë¯¸ì„ íƒ";
        const w = wi.value || "ì°½í˜¸ ë¯¸ì„ íƒ";
        out.textContent = `${h} / ${d} / ${w} ê¸°ì¤€ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ê°œì¸í™”í•´ìš”.`; out.style.color="";
      }
      function loadSaved(){
        try{
          const saved = JSON.parse(localStorage.getItem(KEY)||"{}");
          if(saved.housing) ho.value=saved.housing;
          if(saved.doors)   dr.value=saved.doors;
          if(saved.windows) wi.value=saved.windows;
        }catch{}
        renderSummary();
      }

      async function savePreference(payload){
        const url = `${API_ORIGIN}/api/ai/preference`;
        const res = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if(res.ok) return;
        if(res.status===400) throw new Error("í˜•ì‹ ì˜¤ë¥˜(400)");
        throw new Error("ì„œë²„ ì˜¤ë¥˜("+res.status+")");
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!ho.value || !dr.value || !wi.value){
          out.textContent="ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."; out.style.color="#e11d48"; return;
        }
        const payload = {
          userId: USER_ID,
          housingType: mapHousing(ho.value),
          hasDoubleDoor: mapDoor(dr.value),
          windowType: mapWindow(wi.value)
        };
        if(!ALLOWED_HOUSING.includes(payload.housingType) || !ALLOWED_WINDOW.includes(payload.windowType)){
          out.textContent="í—ˆìš©ë˜ì§€ ì•Šì€ ê°’ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”."; out.style.color="#e11d48"; return;
        }

        out.textContent="ì €ì¥ ì¤‘â€¦"; out.style.color="";
        try{
          await savePreference(payload);
          localStorage.setItem(KEY, JSON.stringify({ housing:ho.value, doors:dr.value, windows:wi.value, ts:Date.now() }));
          renderSummary();
          out.textContent="ì €ì¥ ì™„ë£Œ! ì„ íƒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì¸í™”ë©ë‹ˆë‹¤.";
          if(typeof window.fetchTips === "function") window.fetchTips();
        }catch(err){
          console.error(err);
          out.style.color="#e11d48";
          out.textContent = err.message.includes("í˜•ì‹")
            ? "ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜: ì„ íƒê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”."
            : "ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì˜¤ë¥˜: ë°±ì—”ë“œ ì‹¤í–‰/CORS í—ˆìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
        }
      });

      ["change","input"].forEach(ev=>[ho,dr,wi].forEach(el=>el.addEventListener(ev, renderSummary)));
      document.addEventListener("DOMContentLoaded", loadSaved);
    })();
  </script>

  <!-- ë§ì¶¤ íŒ ì¡°íšŒ (GET /api/ai/tips?userId=&elecCount=&gasCount=) -->
  <script>
    (function(){
      const { API_ORIGIN='', USER_ID } = window.__ENV;
      const ELEC_COUNT = 2, GAS_COUNT = 2;
      const $elec = document.getElementById("elecTips");
      const $gas  = document.getElementById("gasTips");
      if(!$elec || !$gas) return;

      function renderList(ul, items){
        ul.innerHTML = "";
        (items && items.length ? items : ["ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."]).forEach(t=>{
          const li=document.createElement("li"); li.textContent=String(t); ul.appendChild(li);
        });
      }
      function setLoading(){ $elec.innerHTML="<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>"; $gas.innerHTML="<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>"; }

      async function fetchTips(){
        setLoading();
        const url = `${API_ORIGIN}/api/ai/tips?userId=${encodeURIComponent(USER_ID)}&elecCount=${ELEC_COUNT}&gasCount=${GAS_COUNT}`;
        try{
          const res = await fetch(url);
          if(res.status===400){ renderList($elec,["ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜"]); renderList($gas,["ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜"]); return; }
          if(!res.ok){ renderList($elec,["ì„œë²„ ì˜¤ë¥˜"]); renderList($gas,["ì„œë²„ ì˜¤ë¥˜"]); return; }
          const data = await res.json(); // { ELEC:[...], GAS:[...] }
          renderList($elec, Array.isArray(data.ELEC)?data.ELEC:[]);
          renderList($gas , Array.isArray(data.GAS )?data.GAS :[]);
        }catch(err){
          console.error(err);
          renderList($elec,["ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"]);
          renderList($gas ,["ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"]);
        }
      }
      window.fetchTips = fetchTips;
      document.addEventListener("DOMContentLoaded", fetchTips);
    })();
  </script>

  <!-- ë¼ì¸ì°¨íŠ¸ (GET /api/ai/daily-line?userId=&date=YYYY-MM-DD), 30ì´ˆ í´ë§ -->
  <script>
    (function(){
      const { API_ORIGIN='http://localhost:8084', USER_ID } = window.__ENV;
      const container = document.querySelector('.chart-line'); if(!container) return;

      function todayYMD(){ const d = new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }
      function drawEmpty(msg){ container.innerHTML = `<div class="chart-empty">${msg}</div>`; }

      function drawChart(labels, elec, gas){
        container.innerHTML="";
        const width=container.clientWidth||320, height=container.clientHeight||220;
        const M={top:12,right:12,bottom:24,left:32}, iw=width-M.left-M.right, ih=height-M.top-M.bottom;
        const maxY=Math.max(1,...elec,...gas), stepX=iw/Math.max(1,(labels.length-1));
        const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("class","chart-svg"); svg.setAttribute("viewBox",`0 0 ${width} ${height}`); svg.setAttribute("preserveAspectRatio","none");

        const gGrid=document.createElementNS(svg.namespaceURI,"g");
        const gridCnt=4;
        for(let i=0;i<=gridCnt;i++){
          const y=M.top+ih-(ih*i/gridCnt);
          const line=document.createElementNS(svg.namespaceURI,"line");
          line.setAttribute("x1",M.left); line.setAttribute("y1",y);
          line.setAttribute("x2",M.left+iw); line.setAttribute("y2",y);
          line.setAttribute("stroke","rgba(0,0,0,0.08)"); line.setAttribute("stroke-width","1");
          gGrid.appendChild(line);
          const t=document.createElementNS(svg.namespaceURI,"text");
          t.setAttribute("x",M.left-6); t.setAttribute("y",y+3); t.setAttribute("text-anchor","end");
          t.setAttribute("font-size","10"); t.setAttribute("fill","rgba(0,0,0,0.55)"); t.textContent=Math.round(maxY*i/gridCnt);
          gGrid.appendChild(t);
        }
        svg.appendChild(gGrid);

        function pathFrom(arr){ return arr.map((v,i)=>{ const x=M.left+stepX*i, y=M.top+ih-((v/maxY)*ih); return `${i===0?'M':'L'}${x},${y}`; }).join(' '); }
        const pElec=document.createElementNS(svg.namespaceURI,"path");
        pElec.setAttribute("d",pathFrom(elec)); pElec.setAttribute("fill","none"); pElec.setAttribute("stroke","#22c55e"); pElec.setAttribute("stroke-width","2.5");
        svg.appendChild(pElec);
        const pGas=document.createElementNS(svg.namespaceURI,"path");
        pGas.setAttribute("d",pathFrom(gas)); pGas.setAttribute("fill","none"); pGas.setAttribute("stroke","#06b6d4"); pGas.setAttribute("stroke-width","2.5");
        svg.appendChild(pGas);

        const tickEvery=Math.max(1,Math.ceil(labels.length/8));
        const gAxis=document.createElementNS(svg.namespaceURI,"g");
        for(let i=0;i<labels.length;i+=tickEvery){
          const x=M.left+stepX*i;
          const t=document.createElementNS(svg.namespaceURI,"text");
          t.setAttribute("x",x); t.setAttribute("y",height-M.bottom+14);
          t.setAttribute("text-anchor","middle"); t.setAttribute("font-size","10");
          t.setAttribute("fill","rgba(0,0,0,0.55)"); t.textContent=labels[i];
          gAxis.appendChild(t);
        }
        svg.appendChild(gAxis);

        const legend=document.createElementNS(svg.namespaceURI,"g");
        [["#22c55e","ì „ê¸°(kWh)"],["#06b6d4","ê°€ìŠ¤(mÂ³)"]].forEach(([color,label],idx)=>{
          const x=M.left+idx*100, y=M.top+10;
          const l=document.createElementNS(svg.namespaceURI,"line");
          l.setAttribute("x1",x); l.setAttribute("y1",y); l.setAttribute("x2",x+18); l.setAttribute("y2",y);
          l.setAttribute("stroke",color); l.setAttribute("stroke-width","3"); legend.appendChild(l);
          const tx=document.createElementNS(svg.namespaceURI,"text");
          tx.setAttribute("x",x+24); tx.setAttribute("y",y+3);
          tx.setAttribute("font-size","11"); tx.setAttribute("fill","rgba(0,0,0,0.7)");
          tx.textContent=label; legend.appendChild(tx);
        });
        svg.appendChild(legend);
        container.appendChild(svg);
      }

      async function fetchLine(){
        const date ="2025-08-19";
        const url=`${API_ORIGIN}/api/ai/daily-line?userId=${encodeURIComponent(USER_ID)}&date=${encodeURIComponent(date)}`;
        try{
          const res=await fetch(url);
          if(res.status===400){ drawEmpty("ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜: ë‚ ì§œëŠ” YYYY-MM-DD ì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }
          if(!res.ok){ drawEmpty("ì„œë²„ ì˜¤ë¥˜ë¡œ ë¼ì¸ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); return; }
          const data=await res.json();
          const labels=Array.isArray(data.labels)?data.labels:[], elec=Array.isArray(data.elec)?data.elec:[], gas=Array.isArray(data.gas)?data.gas:[];
          if(!labels.length || (!elec.length && !gas.length)){ drawEmpty("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
          drawChart(labels, elec, gas);
        }catch(err){ console.error(err); drawEmpty("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¼ì¸ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
      }

      document.addEventListener("DOMContentLoaded", ()=>{ fetchLine(); setInterval(fetchLine, 30000); });
      window.addEventListener("env:changed", ()=>fetchLine());
      window.fetchLineForDate = fetchLine;
    })();
  </script>

  <!-- ë“œë¡œì–´ í† ê¸€ -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr||!sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
</body>
</html>
